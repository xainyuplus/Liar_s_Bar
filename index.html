<!DOCTYPE html>
<!-- 这个页面是主页+游戏大厅+创建房间 -->
<!-- 如果后面有需要，会再加登录等其他页面 -->
<html lang="en">

<head>
   <meta charset="UTF-8">
   <meta name="viewport" content="width=device-width, initial-scale=1.0">
   <title>Document</title>
   <link rel="stylesheet" href="./CSS/main.css">
</head>
<script src="./JS/main.js"></script>
<script src="./JS/utils/animationUtils.js"></script>
<!-- 引入 SweetAlert2 库 -->
<script src="https://cdn.jsdelivr.net/npm/sweetalert2@11"></script>

<body>
   <h1>欢迎来到游戏大厅</h1>
   <h2>点击下方按钮创建房间</h2>
   <button id="createBtn">创建房间</button>
   <h2>点击下方按钮加入房间</h2>
   <button onclick="joinRoom()">加入房间</button>
</body>
<script src="https://cdn.socket.io/4.7.2/socket.io.min.js"></script>

<script>
   // 点击按钮创建房间
   //创建房间的方式是，向后端发送一个请求，仅包括房主id
   //测试阶段，房主id固定为2233，后期会由数据库记录
   //后端将返回房间id，此时前端生成一个类似弹窗的页面，显示id和已经加入房间的人，还有x号
   //点击x号会有提示，之后退出房间，向后端发信息，之后房间销毁
   //人数达到4个后点击确定可以开始游戏，也可以点击人机模式，之后进入游戏页面

   const socket = io("http://localhost:3000");
   const thisplayerInfo = {
      id: "玩家id",
      name: "玩家名字",
      avatar: "avatar1.png",
      isHost: true
   };
   function createRoom(hostId) {
      socket.emit('create_room', hostId); // 发送创建房间请求
   }

   document.getElementById("createBtn").addEventListener("click", () => {
      createRoom(2233);
   });

   function joinRoom() {
      // 弹出一个输入框，让用户输入房间ID
      const roomId = prompt("请输入房间ID:");
      if (roomId) {
         // 发送加入房间请求
         socket.emit('join_room', {
            roomId,
            playerInfo: thisplayerInfo
         });
         //注意一个问题，发送信息是 如果直接穿变量，前端后端名字应一致，要么就像这样 playerInfo:thisplayerInfo，后端用playerInfo接收
      }

   }
   function startGame() {
      if(thisplayerInfo.isHost){
         Swal.fire({
            title: '准备好了吗？',
            text: "人数不足四人时，将以机器人代替空缺玩家",
            icon: 'question',
            showCancelButton: true,
            confirmButtonColor: '#3085d6',
            cancelButtonColor: '#d33',
            confirmButtonText: '开始游戏',
            cancelButtonText: '取消'

         }).then((result) => {
            if (result.isConfirmed) {
               // 跳转到游戏页面
               

               window.location.href = 'game.html'; // 替换为你的游戏页面路径
            }
            else{
               Swal.fire({
                  title: '已取消',
                  icon: 'error',
                  confirmButtonColor: '#3085d6',
                  confirmButtonText: '确定'
               });
            } 
         })
         


      }
      else{
         Swal.fire({
            title: '你不是房主，无法开始游戏',
            icon: 'error',
            confirmButtonColor: '#3085d6',
            confirmButtonText: '确定'
         }); 
      }
   }
   function closeDiv() {
      //弹窗:你确认要退出房间吗？
      if (thisplayerInfo.isHost) {
         Swal.fire({
            title: '你确认要退出房间吗？',
            text: "房间会被销毁，其他玩家也会被踢出房间",
            icon: 'warning',
            showCancelButton: true,
            confirmButtonColor: '#3085d6',
            cancelButtonColor: '#d33',
            confirmButtonText: '退出',
            cancelButtonText: '取消'
         }).then((result) => {
            if (result.isConfirmed) {
                  //删除房间
               document.getElementById('playersDiv').remove();
               localStorage.removeItem('roomId'); // 从本地存储中移除房间ID
              // socket.emit('close_room', { roomId: localStorage.getItem('roomId') }); // 发送关闭房间请求
              //这一部分后端还没写
            }
         });


      } else {
         Swal.fire({
            title: '你确认要退出房间吗？',
            icon: 'warning',
            showCancelButton: true,
            confirmButtonColor: '#3085d6',
            cancelButtonColor: '#d33',
            confirmButtonText: '退出',
            cancelButtonText: '取消'
         }).then((result) => {
            if (result.isConfirmed) {
                document.getElementById('playersDiv').remove();

            }
         });

      }
   }
</script>
<script>
   socket.on('room_created', (roomId) => {
      console.log(`Room created with ID: ${roomId}`); // 接收创建成功的消息 
      localStorage.setItem('roomId', roomId); //把房间ID保存到本地存储中
      socket.emit('join_room', {
         roomId,
         playerInfo: thisplayerInfo
      }); // 发送加入房间请求
      console.log("发送了加入房间请求");

      const players_Div = playersDiv(roomId);
      //在这里添加一下监听器，一个是关闭，一个是开始游戏
      players_Div.querySelector('#closeButton').addEventListener('click', () => {
         console.log("关闭按钮被点击");
         closeDiv(); // 调用关闭函数
      });
      players_Div.querySelector('#startButton').addEventListener('click', () => {
         console.log("开始游戏按钮被点击");
         startGame(); // 调用开始游戏函数
      });
      //如果玩家非房主的话，隐藏开始游戏按钮
      if (!thisplayerInfo.isHost) {
         players_Div.querySelector('#startButton').style.display = 'none';
      }




      document.body.appendChild(players_Div);
   })
   //房间创建成功后或加入游戏成功后展示一个房间加入页面（div），类似，显示房间号，然后是四个人的头像（未加入的位置显示为空白），下方是两个按钮：准备 和人机对局
   //点击人机对局后

   //接收广播的玩家加入事件，用于同步更新玩家加入界面
   socket.on('player_joined', (playerInfo) => {
      console.log(`Player joined: ${playerInfo.name}`); // 接收玩家加入的消息
      //显示玩家加入的弹窗
      Swal.fire({
         position: 'center',
         icon: 'info',
         title: `${playerInfo.name} 加入了房间`,
         showConfirmButton: false,
         timer: 1500
      });
      //更新玩家加入界面

      Array.from(document.getElementById('playersDiv').querySelectorAll('#avatarsContainer img')).some((player_avatar, index) => {
         if (player_avatar.getAttribute('data-avatar') == "false") {
            player_avatar.src = `./assets/images/avatars/${playerInfo.avatar}`;
            player_avatar.setAttribute('data-avatar', "true");
            return true;
         }

      });
   })


</script>


</html>