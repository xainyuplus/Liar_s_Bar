<!DOCTYPE html>
<!-- è¿™ä¸ªé¡µé¢æ˜¯ä¸»é¡µ+æ¸¸æˆå¤§å…+åˆ›å»ºæˆ¿é—´ -->
<!-- å¦‚æœåé¢æœ‰éœ€è¦ï¼Œä¼šå†åŠ ç™»å½•ç­‰å…¶ä»–é¡µé¢ -->
<html lang="en">

<head>
   <meta charset="UTF-8">
   <meta name="viewport" content="width=device-width, initial-scale=1.0">
   <title>Document</title>

   <link rel="stylesheet" href="./CSS/lobby.css">
   <link rel="stylesheet" href="./CSS/game.css">
   <link rel="stylesheet" href="./CSS/main.css">
   <!-- è¿™å‡ ä¸ªCSSå…¶å®æ˜¯æœ‰å†²çªçš„ï¼Œè¦æƒ³åŠæ³•æ¶ˆé™¤ä¸€ä¸‹ï¼Œç°åœ¨ç®—äº†-->
   <style>
      .player-self {
         position: fixed;
         /* ä½¿ç”¨å›ºå®šå®šä½ */
         left: 20px;
         /* è·ç¦»å±å¹•å·¦ä¾§ 20px */
         bottom: 20px;
         /* è·ç¦»å±å¹•åº•éƒ¨ 20px */
         display: flex;
         /* ä½¿ç”¨ flex å¸ƒå±€ */
         flex-direction: column;
         /* å‚ç›´æ’åˆ—å­å…ƒç´  */
         align-items: center;
         /* å­å…ƒç´ æ°´å¹³å±…ä¸­ */
         background-color: rgba(240, 240, 240, 0.6);
         ;
         /* è®¾ç½®åŠé€æ˜èƒŒæ™¯ */
         padding: 15px;
         /* æ·»åŠ å†…è¾¹è· */
         border-radius: 10px;
         /* åœ†è§’è¾¹æ¡† */
         box-shadow: 0 0 10px rgba(0, 0, 0, 0.2);
         /* æ·»åŠ é˜´å½± */
         z-index: 10;
         /* è®¾ç½® z-indexï¼Œç¡®ä¿æ˜¾ç¤ºåœ¨å…¶ä»–å…ƒç´ ä¹‹ä¸Š */
      }

      .player-self .player-character {
         display: flex;
         flex-direction: column;
         align-items: center;
         margin-bottom: 10px;
         /* ä¸ä¸‹æ–¹ä¿¡æ¯åŒºåŸŸä¿æŒé—´è· */
      }

      .player-self .player-info {
         text-align: center;
         margin-bottom: 10px;
         /* ä¸ä¸‹æ–¹å­å¼¹è®¡æ•°å™¨ä¿æŒé—´è· */
      }

      .player-self .bullet-counter {
         display: flex;
         align-items: center;
      }

      .player-self .bullet-display {
         display: flex;
         margin-left: 5px;
         /* ä¸æªå›¾æ ‡ä¿æŒé—´è· */
      }

      .player-self .bullet {
         display: flex;
         margin-left: 5px;
         /* ä¸æªå›¾æ ‡ä¿æŒé—´è· */

      }

      .player-self .bullet.used {
         background-color: #ccc;
         /* å·²ä½¿ç”¨å­å¼¹é¢œè‰² */
      }
   </style>
</head>
<!-- åŠ è½½æ‰€æœ‰JavaScriptæ¨¡å— -->
<script src="https://cdn.socket.io/4.7.2/socket.io.min.js"></script>
<!--socketæ¨¡å—-->
<script src="js/socket-client.js"></script>

<!-- æ•°æ®æ¨¡å— -->

<!-- UIç»„ä»¶ -->
<script src="js/ui/screens/ScreenManner.js"></script>
<!-- å·¥å…·æ¨¡å— -->
<script src="js/utils/animationUtils.js"></script>
<!-- ä¸»æ§åˆ¶å™¨ -->
<script src="js/main.js"></script>
<!-- å¼•å…¥ SweetAlert2 åº“ -->
<script src="https://cdn.jsdelivr.net/npm/sweetalert2@11"></script>

<body>

   <div id="lobby-screen" style="z-index: 1;" class="screen hidden">
      <div class="bg-decoration"></div>

      <div class="container">
         <!-- é¡¶éƒ¨æ  -->
         <header class="header">
            <div class="user-info">
               <div class="user-avatar">ğŸ˜</div>
               <div class="user-details">
                  <h3>ç©å®¶</h3>
                  <p>ç­‰çº§ 15 | é‡‘å¸ 2,580</p>
               </div>
            </div>
            <button class="settings-btn" onclick="showSettings()">âš™ï¸</button>
         </header>

         <!-- ä¸»è¦å†…å®¹åŒºåŸŸ -->
         <main class="main-content">
            <!-- è§’è‰²å±•ç¤ºåŒº -->
            <section class="character-display">
               <div class="character-container">
                  <div class="character-avatar">
                     <div class="character-accessory">ğŸ©</div>
                     <div class="character-head">ğŸ˜</div>
                     <div class="character-clothes">ğŸ‘—</div>
                     <div class="character-item-left">ğŸ’°</div>
                     <div class="character-item-right">ğŸ—ï¸</div>
                  </div>
                  <h2 class="character-name">ç¥ç§˜æ—…è€…</h2>
                  <p class="character-title">é…’é¦†å¸¸å®¢ Â· çœŸç›¸æ¢ç´¢è€…</p>
                  <button class="customize-btn" onclick="customizeCharacter()">
                     ğŸ­ æ¢è£…æ‰“æ‰®
                  </button>
               </div>
            </section>

            <!-- åŠŸèƒ½æŒ‰é’®åŒº -->
            <section class="function-area">
               <div class="main-actions">
                  <button class="primary-btn" id="createBtn" onclick="createRoom()">
                     ğŸ  åˆ›å»ºæˆ¿é—´
                  </button>

                  <div class="join-room-container">
                     <input type="text" class="room-input" placeholder="è¾“å…¥æˆ¿é—´å·" id="roomId">
                     <button class="secondary-btn" onclick="joinRoom()">ğŸšª åŠ å…¥</button>
                  </div>

                  <button class="secondary-btn" onclick="quickMatch()">
                     ğŸ² å¿«é€ŸåŒ¹é…
                  </button>
               </div>

               <!-- è¾…åŠ©åŠŸèƒ½åŒº -->
               <div class="secondary-features">
                  <div class="feature-card" onclick="openShop()">
                     <span class="feature-icon">ğŸ›ï¸</span>
                     <div class="feature-title">å•†åº—</div>
                     <div class="feature-desc">è£…æ‰®é“å…·</div>
                  </div>

                  <div class="feature-card" onclick="openActivity()">
                     <span class="feature-icon">ğŸ‰</span>
                     <div class="feature-title">æ´»åŠ¨</div>
                     <div class="feature-desc">æ¯æ—¥ä»»åŠ¡</div>
                  </div>

                  <div class="feature-card" onclick="openRanking()">
                     <span class="feature-icon">ğŸ†</span>
                     <div class="feature-title">æ’è¡Œæ¦œ</div>
                     <div class="feature-desc">é«˜æ‰‹å¦‚äº‘</div>
                  </div>
               </div>
            </section>
         </main>
      </div>

      <!-- å¥½å‹ä¾§æ  -->
      <div class="friends-sidebar" id="friendsSidebar">
         <button class="friends-toggle" onclick="toggleFriends()">ğŸ‘¥</button>
         <div class="friends-header">å¥½å‹åˆ—è¡¨</div>
         <div class="friends-list">
            <div class="friend-item">
               <div class="friend-avatar">ğŸ˜ŠğŸ©</div>
               <div class="friend-info">
                  <h4>æ™ºæ…§æ³•å¸ˆ</h4>
                  <p>æ­£åœ¨æ¸¸æˆä¸­</p>
               </div>
               <div class="online-status"></div>
            </div>

            <div class="friend-item">
               <div class="friend-avatar">ğŸ¤”ğŸ’¼</div>
               <div class="friend-info">
                  <h4>å•†äººè€æ¿</h4>
                  <p>5åˆ†é’Ÿå‰åœ¨çº¿</p>
               </div>
               <div class="online-status offline-status"></div>
            </div>

            <div class="friend-item">
               <div class="friend-avatar">ğŸ˜ğŸ—ï¸</div>
               <div class="friend-info">
                  <h4>ç¥ç§˜ç›—è´¼</h4>
                  <p>æ­£åœ¨å¤§å…</p>
               </div>
               <div class="online-status"></div>
            </div>

            <div class="friend-item">
               <div class="friend-avatar">ğŸ˜ğŸ­</div>
               <div class="friend-info">
                  <h4>è¡¨æ¼”è‰ºæœ¯å®¶</h4>
                  <p>ç¦»çº¿</p>
               </div>
               <div class="online-status offline-status"></div>
            </div>
         </div>
      </div>
   </div>

   <div id="room-wating" style="z-index: 2;">
      <div id="playersDiv" style="display: none; flex-direction: column; align-items: center; position: relative;">
         <button id="closeButton"
            style="position: absolute; top: 10px; right: 10px; font-size: 24px; border: none; cursor: pointer;">Ã—</button><span
            id="roomIDspan"></span>
         <div id="avatarsContainer" style="display: flex; justify-content: space-around; width: 100%;">
            <img src="./assets/images/avatars/avatar0.png" style="width: 60px; height: 60px; margin: 10px;">
            <img src="./assets/images/avatars/avatar0.png" style="width: 60px; height: 60px; margin: 10px;">
            <img src="./assets/images/avatars/avatar0.png" style="width: 60px; height: 60px; margin: 10px;">
            <img src="./assets/images/avatars/avatar0.png" style="width: 60px; height: 60px; margin: 10px;">
         </div>
         <div id="namesContainer" style="display: flex; justify-content: space-around; width: 100%;"><span
               style="margin: 10px;">ç©å®¶1</span><span style="margin: 10px;">ç©å®¶2</span><span
               style="margin: 10px;">ç©å®¶3</span><span style="margin: 10px;">ç©å®¶4</span></div><button
            id="startButton">å¼€å§‹æ¸¸æˆ</button>
      </div>
   </div>

   <div id="loading-overlay" style="z-index: 3;">
      <div class="spinner"></div>
      <div class="loading-text" id="loading-text">åŠ è½½ä¸­</div>
      <div class="loading-dots"></div>
   </div>
   <div id="game-screen" style=" z-index: 1;" class="screen hidden">
      <div class="game-container">
         <!-- ç©å®¶è‡ªèº«åŒºåŸŸ -->
         <div class="player-self" id="playerSelf">
            <!-- ç©å®¶è§’è‰² -->
            <div class="player-character">
               <!-- ç©å®¶è§’è‰²é…é¥° -->
               <div class="character-accessory">ğŸ©</div>
               <!-- ç©å®¶è§’è‰²å¤´éƒ¨ -->
               <div class="character-head">ğŸ˜</div>
               <!-- ç©å®¶è§’è‰²è¡£æœ -->
               <div class="character-clothes">ğŸ‘—</div>
               <!-- ç©å®¶è§’è‰²å·¦ä¾§ç‰©å“ -->
               <div class="character-item-left">ğŸ’°</div>
               <!-- ç©å®¶è§’è‰²å³ä¾§ç‰©å“ -->
               <div class="character-item-right">ğŸ—ï¸</div>
            </div>
            <!-- ç©å®¶ä¿¡æ¯ -->
            <div class="player-info">
               <!-- ç©å®¶åç§° -->
               <div class="player-name">ç©å®¶</div>
               <!-- ç©å®¶ç‰Œæ•°é‡ -->
               <div class="player-cards">5 å¼ ç‰Œ</div>
            </div>
            <!-- ç©å®¶å­å¼¹è®¡æ•°å™¨ -->
            <div class="bullet-counter">
               <!-- æªå›¾æ ‡ -->
               <span>ğŸ”«</span>
               <!-- å­å¼¹æ˜¾ç¤ºåŒºåŸŸ -->
               <div class="bullet-display">
                  <!-- 6 é¢—æœªä½¿ç”¨çš„å­å¼¹ -->
                  <div class="bullet"></div>
                  <div class="bullet"></div>
                  <div class="bullet"></div>
                  <div class="bullet"></div>
                  <div class="bullet"></div>
                  <div class="bullet"></div>
               </div>
            </div>
         </div>
         <!-- å€’è®¡æ—¶å™¨ -->
         <div class="timer-area">
            <!-- å€’è®¡æ—¶æ˜¾ç¤ºåŒºåŸŸï¼Œåˆå§‹å€¼ä¸º 30 -->
            <div class="timer" id="timer">30</div>
         </div>

         <!-- ç›®æ ‡ç‰ŒåŒºåŸŸ -->
         <div class="target-area">
            <!-- ç›®æ ‡ç‰Œæ ‡ç­¾ -->
            <div class="target-label">ç›®æ ‡ç‰Œ</div>
            <!-- ç›®æ ‡ç‰Œæ˜¾ç¤ºåŒºåŸŸï¼Œåˆå§‹å€¼ä¸º â™ K -->
            <div class="target-card" id="targetCard"></div>
            <!-- å›åˆä¿¡æ¯ï¼Œåˆå§‹ä¸ºç¬¬ 1 è½® -->
            <div class="round-info">ç¬¬ 1 è½®</div>
         </div>

         <!-- æ¸¸æˆä¸»åŒºåŸŸ -->
         <div class="game-main">
            <!-- ç¬¬ä¸€ä¸ªå¯¹æ‰‹ -->
            <div class="opponent" id="opponent2">
               <!-- å¯¹æ‰‹è§’è‰² -->
               <div class="opponent-character">
                  <!-- å¯¹æ‰‹è§’è‰²é…é¥° -->
                  <div class="character-accessory">ğŸ©</div>
                  <!-- å¯¹æ‰‹è§’è‰²å¤´éƒ¨ -->
                  <div class="character-head">ğŸ˜Š</div>
                  <!-- å¯¹æ‰‹è§’è‰²è¡£æœ -->
                  <div class="character-clothes">ğŸ‘”</div>
                  <!-- å¯¹æ‰‹è§’è‰²å·¦ä¾§ç‰©å“ -->
                  <div class="character-item-left">ğŸ’°</div>
                  <!-- å¯¹æ‰‹è§’è‰²å³ä¾§ç‰©å“ -->
                  <div class="character-item-right">ğŸ”</div>
               </div>
               <!-- å¯¹æ‰‹ä¿¡æ¯ -->
               <div class="opponent-info">
                  <!-- å¯¹æ‰‹åç§° -->
                  <div class="opponent-name">æ™ºæ…§æ³•å¸ˆ</div>
                  <!-- å¯¹æ‰‹ç‰Œæ•°é‡ -->
                  <div class="opponent-cards">5 å¼ ç‰Œ</div>
               </div>
               <!-- å¯¹æ‰‹å­å¼¹è®¡æ•°å™¨ -->
               <div class="bullet-counter">
                  <!-- æªå›¾æ ‡ -->
                  <span>ğŸ”«</span>
                  <!-- å­å¼¹æ˜¾ç¤ºåŒºåŸŸ -->
                  <div class="bullet-display">
                     <!-- 6 é¢—æœªä½¿ç”¨çš„å­å¼¹ -->
                     <div class="bullet"></div>
                     <div class="bullet"></div>
                     <div class="bullet"></div>
                     <div class="bullet"></div>
                     <div class="bullet"></div>
                     <div class="bullet"></div>
                  </div>
               </div>
            </div>
            <!-- ç¬¬äºŒä¸ªå¯¹æ‰‹ -->
            <div class="opponent" id="opponent3">
               <!-- å¯¹æ‰‹è§’è‰² -->
               <div class="opponent-character">
                  <!-- å¯¹æ‰‹è§’è‰²é…é¥° -->
                  <div class="character-accessory">ğŸ’¼</div>
                  <!-- å¯¹æ‰‹è§’è‰²å¤´éƒ¨ -->
                  <div class="character-head">ğŸ¤”</div>
                  <!-- å¯¹æ‰‹è§’è‰²è¡£æœ -->
                  <div class="character-clothes">ğŸ¦º</div>
                  <!-- å¯¹æ‰‹è§’è‰²å·¦ä¾§ç‰©å“ -->
                  <div class="character-item-left">ğŸ“Š</div>
                  <!-- å¯¹æ‰‹è§’è‰²å³ä¾§ç‰©å“ -->
                  <div class="character-item-right">ğŸ’</div>
               </div>
               <!-- å¯¹æ‰‹ä¿¡æ¯ -->
               <div class="opponent-info">
                  <!-- å¯¹æ‰‹åç§° -->
                  <div class="opponent-name">å•†äººè€æ¿</div>
                  <!-- å¯¹æ‰‹ç‰Œæ•°é‡ -->
                  <div class="opponent-cards">5å¼ ç‰Œ</div>
               </div>
               <!-- å¯¹æ‰‹å­å¼¹è®¡æ•°å™¨ -->
               <div class="bullet-counter">
                  <!-- æªå›¾æ ‡ -->
                  <span>ğŸ”«</span>
                  <!-- å­å¼¹æ˜¾ç¤ºåŒºåŸŸ -->
                  <div class="bullet-display">
                     <!-- 3 é¢—æœªä½¿ç”¨çš„å­å¼¹å’Œ 3 é¢—å·²ä½¿ç”¨çš„å­å¼¹ -->
                     <div class="bullet"></div>
                     <div class="bullet"></div>
                     <div class="bullet"></div>
                     <div class="bullet "></div>
                     <div class="bullet "></div>
                     <div class="bullet "></div>
                  </div>
               </div>
            </div>
            <!-- ç¬¬ä¸‰ä¸ªå¯¹æ‰‹ï¼Œå¤„äºæ¿€æ´»çŠ¶æ€ -->
            <div class="opponent active" id="opponent1">
               <!-- å¯¹æ‰‹è§’è‰² -->
               <div class="opponent-character">
                  <!-- å¯¹æ‰‹è§’è‰²é…é¥° -->
                  <div class="character-accessory">ğŸ­</div>
                  <!-- å¯¹æ‰‹è§’è‰²å¤´éƒ¨ -->
                  <div class="character-head">ğŸ˜</div>
                  <!-- å¯¹æ‰‹è§’è‰²è¡£æœ -->
                  <div class="character-clothes">ğŸ‘˜</div>
                  <!-- å¯¹æ‰‹è§’è‰²å·¦ä¾§ç‰©å“ -->
                  <div class="character-item-left">ğŸ—ï¸</div>
                  <!-- å¯¹æ‰‹è§’è‰²å³ä¾§ç‰©å“ -->
                  <div class="character-item-right">âš”ï¸</div>
               </div>
               <!-- å¯¹æ‰‹ä¿¡æ¯ -->
               <div class="opponent-info">
                  <!-- å¯¹æ‰‹åç§° -->
                  <div class="opponent-name">ç¥ç§˜ç›—è´¼</div>
                  <!-- å¯¹æ‰‹ç‰Œæ•°é‡ -->
                  <div class="opponent-cards">5 å¼ ç‰Œ</div>
               </div>
               <!-- å¯¹æ‰‹å­å¼¹è®¡æ•°å™¨ -->
               <div class="bullet-counter">
                  <!-- æªå›¾æ ‡ -->
                  <span>ğŸ”«</span>
                  <!-- å­å¼¹æ˜¾ç¤ºåŒºåŸŸ -->
                  <div class="bullet-display">
                     <!-- 6 é¢—æœªä½¿ç”¨çš„å­å¼¹ -->
                     <div class="bullet"></div>
                     <div class="bullet"></div>
                     <div class="bullet"></div>
                     <div class="bullet"></div>
                     <div class="bullet"></div>
                     <div class="bullet"></div>
                  </div>
               </div>
            </div>

            <!-- ä¸­å¤®ç‰Œæ¡Œ -->
            <div class="table-area">

               <div class="table-center">
                  <!-- å·²å‡ºç‰ŒåŒºåŸŸ -->
                  <div class="played-cards-area" id="playedCards"></div>

                  <!-- å‡ºç‰Œä¿¡æ¯ -->
                  <div class="played-info" id="playedInfo">qq</div>
               </div>
            </div>
         </div>
      </div>

      <!-- æ‰‹ç‰ŒåŒºåŸŸ -->
      <div class="hand-area">
         <!-- æ‰‹ç‰Œæ˜¾ç¤ºåŒºåŸŸ -->
         <div class="hand-cards" id="handCards">

         </div>

         <!-- è¡ŒåŠ¨æŒ‰é’®åŒºåŸŸ -->
         <div class="action-area">
            <!-- è´¨ç–‘æŒ‰é’®ï¼Œç‚¹å‡»è§¦å‘è´¨ç–‘å‡½æ•° -->
            <button class="action-btn" id="challengeBtn" onclick="challenge()">
               ğŸ”« è´¨ç–‘
            </button>
            <!-- é€‰æ‹©ä¿¡æ¯æ˜¾ç¤ºåŒºåŸŸ -->
            <div class="selection-info" id="selectionInfo">
               è¯·é€‰æ‹© 1-3 å¼ ç‰Œ
            </div>
            <!-- å‡ºç‰ŒæŒ‰é’®ï¼Œåˆå§‹ç¦ç”¨ï¼Œç‚¹å‡»è§¦å‘å‡ºç‰Œå‡½æ•° -->
            <button class="action-btn" id="playBtn" onclick="playSelectedCards()">
               ğŸƒ å‡ºç‰Œ
            </button>
         </div>
      </div>

      <!-- èŠå¤©ä¸è¡¨æƒ…é¢æ¿ -->
      <div class="chat-panel" id="chatPanel">
         <div class="chat-header">
            <span>ğŸ’¬ èŠå¤© & è¡¨æƒ…</span>
            <button class="chat-toggle" id="chatToggle" onclick="toggleChat()">âˆ’</button>
         </div>
         <div class="chat-content" id="chatContent">
            <div class="chat-messages" id="chatMessages">
               <div class="chat-message system">æ¸¸æˆå¼€å§‹ï¼ç›®æ ‡ç‰Œæ˜¯ K</div>
               <div class="chat-message player">æ™ºæ…§æ³•å¸ˆ: ğŸ˜Š å¤§å®¶å¥½è¿ï¼</div>
               <div class="chat-message player">å•†äººè€æ¿: ğŸ¤” è®©æˆ‘æƒ³æƒ³...</div>
            </div>

            <div class="toggle-buttons">
               <button class="toggle" id="toggle-emoji-btn" onclick="toggleEmojiPanel()">
                  ğŸ˜€ æ˜¾ç¤ºè¡¨æƒ…
               </button>
               <button class="toggle" id="toggle-quick-btn" onclick="toggleQuickPanel()">
                  ğŸ’¬ æ˜¾ç¤ºçŸ­è¯­
               </button>
               <button class="toggle" id="send-btn" onclick="sendMessage()">å‘é€</button>
               <div class="message-input-container">
                  <input type="text" id="messageInput" class="message-input" placeholder="è¾“å…¥æ¶ˆæ¯...">
               </div>
            </div>

            <div class="expression-area" id="expressionArea">
               <div class="expression-label">å¿«é€Ÿè¡¨æƒ…</div>
               <div class="expression-grid">
                  <button class="expression-btn" onclick="insertIntoInput('ğŸ˜Š')">ğŸ˜Š</button>
                  <button class="expression-btn" onclick="insertIntoInput('ğŸ˜')">ğŸ˜</button>
                  <button class="expression-btn" onclick="insertIntoInput('ğŸ¤”')">ğŸ¤”</button>
                  <button class="expression-btn" onclick="insertIntoInput('ğŸ˜')">ğŸ˜</button>
                  <button class="expression-btn" onclick="insertIntoInput('ğŸ˜°')">ğŸ˜°</button>
                  <button class="expression-btn" onclick="insertIntoInput('ğŸ™„')">ğŸ™„</button>
                  <button class="expression-btn" onclick="insertIntoInput('ğŸ˜¤')">ğŸ˜¤</button>
                  <button class="expression-btn" onclick="insertIntoInput('ğŸ¤¨')">ğŸ¤¨</button>
                  <button class="expression-btn" onclick="insertIntoInput('ğŸ˜®')">ğŸ˜®</button>
                  <button class="expression-btn" onclick="insertIntoInput('ğŸ¤—')">ğŸ¤—</button>
                  <button class="expression-btn" onclick="insertIntoInput('ğŸ¤«')">ğŸ¤«</button>
                  <button class="expression-btn" onclick="insertIntoInput('ğŸ˜ˆ')">ğŸ˜ˆ</button>
               </div>
            </div>

            <div class="expression-area" id="quickPanel">
               <div class="expression-label">å¿«æ·çŸ­è¯­</div>
               <div class="quick-messages">
                  <button class="quick-msg-btn" onclick="insertIntoInput('æˆ‘è§‰å¾—ä½ åœ¨æ’’è°ï¼')">ğŸ” æˆ‘è§‰å¾—ä½ åœ¨æ’’è°ï¼</button>
                  <button class="quick-msg-btn" onclick="insertIntoInput('ç›¸ä¿¡æˆ‘ï¼Œè¿™æ˜¯çœŸçš„')">ğŸ¤ ç›¸ä¿¡æˆ‘ï¼Œè¿™æ˜¯çœŸçš„</button>
                  <button class="quick-msg-btn" onclick="insertIntoInput('è®©æˆ‘æƒ³æƒ³...')">ğŸ¤” è®©æˆ‘æƒ³æƒ³...</button>
                  <button class="quick-msg-btn" onclick="insertIntoInput('å¥½é™©ï¼')">ğŸ˜… å¥½é™©ï¼</button>
               </div>
            </div>
         </div>
      </div>

      <!-- æ¸¸æˆçŠ¶æ€æç¤º ,è¿™ç©æ„ä»¥åè‚¯å®šè¦åˆ æ‰ï¼Œä»…ä¾›è°ƒè¯•-->
      <div class="game-event-info" id="gameEventInfo">
         <h3>æ¸¸æˆäº‹ä»¶ä¿¡æ¯</h3>
         <div id="eventMessages"></div>
         <button class="action-btn" onclick="clearEventMessages()">æ¸…é™¤ä¿¡æ¯</button>
      </div>

   </div>
</body>
<script>
   //è¿™é‡Œæ”¾é‚£ä¸ªåŠ è½½é¡µé¢çš„å‡½æ•°
   //é¦–å…ˆæ˜¯ä¸€ä¸ªä¸“åœºåŠ¨ç”»æ§åˆ¶ç±»
   class LoadingTransition {
      constructor() {
         this.overlay = document.getElementById('loading-overlay');
         this.textElement = document.getElementById('loading-text');

         this.isShowing = false;
      }

      // å¼€å§‹è½¬åœºåŠ¨ç”»
      show(text) {
         this.textElement.textContent = text;
         this.overlay.classList.add('show');
         this.isShowing = true;

         return new Promise(resolve => {
            // ç­‰å¾…åŠ¨ç”»å®Œæˆåè¿”å›
            setTimeout(resolve, 300);
         });
      }

      // ç»“æŸè½¬åœºåŠ¨ç”»
      hide() {
         this.overlay.classList.remove('show');
         this.isShowing = false;

         return new Promise(resolve => {
            // ç­‰å¾…åŠ¨ç”»å®Œæˆåè¿”å›
            setTimeout(resolve, 300);
         });
      }

      // æ›´æ–°åŠ è½½æ–‡å­—
      updateText(text) {
         this.textElement.textContent = text;
      }

      // æ£€æŸ¥æ˜¯å¦æ­£åœ¨æ˜¾ç¤º
      isVisible() {
         return this.isShowing;
      }
   }

   // åˆ›å»ºå…¨å±€è½¬åœºåŠ¨ç”»å®ä¾‹
   const loadingTransition = new LoadingTransition();
   console.log(loadingTransition);

   // å¸¦è½¬åœºåŠ¨ç”»çš„é¡µé¢åˆ‡æ¢å‡½æ•°ï¼ˆè¿™é‡Œæœ‰åŒæ­¥æ–¹æ³•ï¼Œéå¸¸å¥½ï¼‰
   async function showScreenWithLoading(screenName, loadingText) {
      // 1. æ˜¾ç¤ºåŠ è½½åŠ¨ç”»
      await loadingTransition.show(loadingText || 'åˆ‡æ¢é¡µé¢ä¸­');

      // 2. æ¨¡æ‹Ÿä¸€äº›å¤„ç†æ—¶é—´ï¼ˆå®é™…é¡¹ç›®ä¸­å¯èƒ½æ˜¯æ•°æ®åŠ è½½ï¼‰
      await new Promise(resolve => setTimeout(resolve, 500));

      // 3. æ‰§è¡Œé¡µé¢åˆ‡æ¢
      switchScreen(screenName);

      // 4. éšè—åŠ è½½åŠ¨ç”»
      await loadingTransition.hide();
   }

   // å®é™…çš„é¡µé¢åˆ‡æ¢é€»è¾‘
   function switchScreen(screenName) {
      console.log('åˆ‡æ¢åˆ°é¡µé¢:', screenName);

      // éšè—æ‰€æœ‰é¡µé¢
      document.querySelectorAll('.screen').forEach(screen => {
         screen.classList.add('hidden');
      });

      // æ˜¾ç¤ºç›®æ ‡é¡µé¢
      const targetScreen = document.getElementById(screenName + '-screen');
      if (targetScreen) {
         targetScreen.classList.remove('hidden');
      }
   }
</script>
<script>
   //è¿™é‡Œæ˜¯ç•Œé¢åˆå§‹åŒ–
   window.onload = function () {
      showScreenWithLoading("lobby", "åŠ è½½æ¸¸æˆå¤§å…ä¸­")

   }


</script>
<script>
   //ä¸€ä¼šè€ƒè™‘å†™ä¸€ä¸ªä»æœåŠ¡å™¨ç«¯éšæœºè·å¾—åå­—ä¸IDä¸å¤´åƒçš„å‡½æ•°ï¼ˆå·²ç»å†™å¥½ï¼Œä½†æ˜¯ç¼ºè¶³å¤Ÿå¤´åƒï¼‰
   //æ¥ç€æˆ‘ä¼šè¡¥å……ä¸€ä¸ªgameStateç±»ï¼Œè¿™ä¸ªç±»ä¼šåŒ…å«æ‰€æœ‰çš„æ¸¸æˆé€»è¾‘
   const expressions = ['ğŸ˜', 'ğŸ˜Š', 'ğŸ˜', 'ğŸ¤”', 'ğŸ˜', 'ğŸ™‚'];
   const clothes = ['ğŸ‘—', 'ğŸ‘”', 'ğŸ¦º', 'ğŸ‘˜', 'ğŸ¥»'];
   const accessories = ['ğŸ©', 'ğŸ‘‘', 'ğŸ“', 'ğŸ‘’', 'ğŸ§¢'];
   const leftItems = ['ğŸ’°', 'ğŸ—ï¸', 'ğŸ­', 'ğŸ”', 'ğŸ“œ'];
   const rightItems = ['âš”ï¸', 'ğŸ›¡ï¸', 'ğŸ†', 'ğŸ’', 'ğŸ¯'];


   function updateLobbyPlayerInfo(playerInfo) {
      const { name, OverLook } = playerInfo;
      // æ›´æ–°ç”¨æˆ·ä¿¡æ¯
      const userInfo = document.querySelector('.user-info .user-details h3');
      userInfo.textContent = name;

      // æ›´æ–°è§’è‰²å±•ç¤ºåŒº
      const characterHead = document.querySelector('.character-display .character-head');
      const characterClothes = document.querySelector('.character-display .character-clothes');
      const characterAccessory = document.querySelector('.character-display .character-accessory');
      const characterItemLeft = document.querySelector('.character-display .character-item-left');
      const characterItemRight = document.querySelector('.character-display .character-item-right');
      const characterName = document.querySelector('.character-display .character-name');

      characterHead.textContent = expressions[OverLook[0]];
      characterClothes.textContent = clothes[OverLook[1]];
      characterAccessory.textContent = accessories[OverLook[2]];
      characterItemLeft.textContent = leftItems[OverLook[3]];
      characterItemRight.textContent = rightItems[OverLook[4]];
      characterName.textContent = name;
   }

   function updateGameOpponentInfo(opponentInfos) {
      opponentInfos.forEach((opponentInfo, index) => {
         const { id, name, OverLook } = opponentInfo;
         const opponentElement = document.getElementById(`opponent${index + 1}`);
         if (opponentElement) {
            const opponentCharacterHead = opponentElement.querySelector('.character-head');
            const opponentCharacterClothes = opponentElement.querySelector('.character-clothes');
            const opponentCharacterAccessory = opponentElement.querySelector('.character-accessory');
            const opponentCharacterItemLeft = opponentElement.querySelector('.character-item-left');
            const opponentCharacterItemRight = opponentElement.querySelector('.character-item-right');
            const opponentName = opponentElement.querySelector('.opponent-name');

            opponentCharacterHead.textContent = expressions[OverLook[0]];
            opponentCharacterClothes.textContent = clothes[OverLook[1]];
            opponentCharacterAccessory.textContent = accessories[OverLook[2]];
            opponentCharacterItemLeft.textContent = leftItems[OverLook[3]];
            opponentCharacterItemRight.textContent = rightItems[OverLook[4]];
            opponentName.textContent = name;
            opponentName.dataset.player_id = id; // æ·»åŠ  data-player_id å±æ€§
            console.log(opponentName.dataset.player_id);
         }
      });
      console.log("æˆ‘æ‰§è¡Œå®Œäº†");
   }

   // åˆå§‹åŒ–æ¸²æŸ“ç©å®¶è‡ªèº«å½¢è±¡å’Œå­å¼¹æ•°çš„å‡½æ•°
   function renderPlayerSelf() {
      const playerSelf = document.getElementById('playerSelf');
      const playerInfo = gameState.playerInfo;
      const gameManager = gameState.gameManager;

      // æ›´æ–°ç©å®¶åç§°
      const playerName = playerSelf.querySelector('.player-name');
      playerName.textContent = playerInfo.name;

      // æ›´æ–°ç©å®¶è§’è‰²å½¢è±¡
      const playerCharacterHead = playerSelf.querySelector('.character-head');
      const playerCharacterClothes = playerSelf.querySelector('.character-clothes');
      const playerCharacterAccessory = playerSelf.querySelector('.character-accessory');
      const playerCharacterItemLeft = playerSelf.querySelector('.character-item-left');
      const playerCharacterItemRight = playerSelf.querySelector('.character-item-right');

      playerCharacterHead.textContent = expressions[playerInfo.OverLook[0]];
      playerCharacterClothes.textContent = clothes[playerInfo.OverLook[1]];
      playerCharacterAccessory.textContent = accessories[playerInfo.OverLook[2]];
      playerCharacterItemLeft.textContent = leftItems[playerInfo.OverLook[3]];
      playerCharacterItemRight.textContent = rightItems[playerInfo.OverLook[4]];

      // æ›´æ–°ç©å®¶ç‰Œæ•°é‡
      const playerCards = playerSelf.querySelector('.player-cards');
      playerCards.textContent = `${gameManager.hands.length} å¼ ç‰Œ`;

      // æ›´æ–°ç©å®¶å­å¼¹æ•°ï¼ˆå‡è®¾åˆå§‹ 6 é¢—å­å¼¹ï¼Œå¯æ ¹æ®å®é™…æƒ…å†µä¿®æ”¹ï¼‰
      const bullets = playerSelf.querySelectorAll('.bullet');
      const remainingBullets = gameState.gameManager.bullets; // è¿™é‡Œéœ€è¦æ ¹æ®å®é™…æ¸¸æˆé€»è¾‘ä¿®æ”¹
      bullets.forEach((bullet, index) => {
         bullet.classList.toggle('used', index >= remainingBullets);
      });
   }
   class GameState {
      constructor() {
         this.playerInfo = {
            id: 2233,  //è¿™ä¸ªæ— æ‰€è°“ï¼Œä»¥åä¼šä»æœåŠ¡å™¨ç«¯è·å–
            name: null,
            avatar: null,
            OverLook: [],
            isHost: false,
            isRobot: false

         },
            this.roomInfo = {
               roomId: null,
               playerList: [],
               updateList: function (playerList) {
                  this.playerList = playerList;
                  //æ›´æ–°ç©å®¶åˆ—è¡¨
                  Array.from(document.getElementById('playersDiv').querySelectorAll('#avatarsContainer img')).forEach((img, index) => {
                     if (index < playerList.length) {
                        img.src = `./assets/images/avatars/${playerList[index].avatar}`; // æ›´æ–°å¤´åƒ
                        img.alt = playerList[index].name; // æ›´æ–°åå­— 
                     }
                     else {
                        img.src = `./assets/images/avatars/avatar0.png`; // æ›´æ–°å¤´åƒ
                        img.alt = ""; // æ›´æ–°åå­— 
                     }
                  })
               }

            },
            this.gameManager = {
               gamePhase: 'waiting', // 'waiting', 'playing', 'challenge', 'roulette', 'over'
               targetCard: null,  // å½“å‰ç›®æ ‡ç‰Œ: 'J', 'Q', 'K'
               currentPlayerId: null, // å½“å‰å‡ºç‰Œç©å®¶ID
               lastPlayerId: null,    // ä¸Šä¸€ä¸ªå‡ºç‰Œçš„ç©å®¶ID
               roulettePlayerId: null, // æ­£åœ¨è½®ç›˜èµŒçš„ç©å®¶ID
               roundNumber: 0,      // å½“å‰å›åˆæ•°

               // æ‰€æœ‰ç©å®¶ä¿¡æ¯ - ä½¿ç”¨Mapå­˜å‚¨
               players: new Map(),    // playerId -> playerInfo
               eliminatedPlayers: [], // å·²æ·˜æ±°ç©å®¶IDé›†åˆ

               // æˆ‘çš„ä¿¡æ¯
               hands: [],           // æˆ‘çš„æ‰‹ç‰Œæ•°ç»„
               bullets: 6,           // æˆ‘çš„å­å¼¹æ•°


               // æ¡Œé¢ä¿¡æ¯
               //deskCards: [],       // æ¡Œé¢å¡ç‰Œä¿¡æ¯
               lastPlayedCount: 0,  // ä¸Šæ¬¡å‡ºç‰Œæ•°é‡
               lastDeclaredValue: null, // ä¸Šæ¬¡å£°ç§°çš„ç‰Œå€¼
               lastActualCards: [],  // ä¸Šæ¬¡å®é™…å‡ºçš„ç‰Œï¼ˆè´¨ç–‘åå¯è§ï¼‰
            }
         initPlayerInfo().then(playerData => {
            Object.assign(this.playerInfo, playerData);
            console.log(this.playerInfo);
            // åˆå§‹åŒ–å®Œæˆåï¼Œæ›´æ–°ç©å®¶ä¿¡æ¯æ˜¾ç¤º
            updateLobbyPlayerInfo(this.playerInfo);
         }).catch(error => {
            console.error('åˆå§‹åŒ–ç©å®¶ä¿¡æ¯å¤±è´¥:', error);
         });
      }

   }
   //è¿™é‡Œåº”è¯¥æ˜¯ä»æœåŠ¡å™¨ç«¯è·å–åå­—ä¸IDä¸å¤´åƒçš„å‡½æ•° 
   async function initPlayerInfo() {
      try {
         // ä»æœåŠ¡å™¨ç«¯è·å–åå­—ä¸IDä¸å¤´åƒçš„å‡½æ•° 
         const response = await fetch('http://localhost:3000/getRandomIdentity');
         // æ£€æŸ¥å“åº”çŠ¶æ€æ˜¯å¦æ­£å¸¸
         if (!response.ok) {
            throw new Error(`HTTP error! status: ${response.status}`);
         }
         // å°†å“åº”æ•°æ®è§£æä¸º JSON æ ¼å¼
         const data = await response.json();
         // å¤„ç†è¿”å›çš„æ•°æ®
         //è¿”å›çš„æ•°æ®ç±»å‹ä¸ºres.json({ name: randomName, avatar: randomAvatar, OverLook: randomOverLook });
         console.log(data);
         return data;
      } catch (error) {
         console.error('è·å–ç©å®¶ä¿¡æ¯å¤±è´¥:', error);
         return {};
      }
   }

   const gameState = new GameState();

   // ç‚¹å‡»æŒ‰é’®åˆ›å»ºæˆ¿é—´
   //åˆ›å»ºæˆ¿é—´çš„æ–¹å¼æ˜¯ï¼Œå‘åç«¯å‘é€ä¸€ä¸ªè¯·æ±‚ï¼Œä»…åŒ…æ‹¬æˆ¿ä¸»id
   //æµ‹è¯•é˜¶æ®µï¼Œæˆ¿ä¸»idå›ºå®šä¸º2233ï¼ŒåæœŸä¼šç”±æ•°æ®åº“è®°å½•
   //åç«¯å°†è¿”å›æˆ¿é—´idï¼Œæ­¤æ—¶å‰ç«¯ç”Ÿæˆä¸€ä¸ªç±»ä¼¼å¼¹çª—çš„é¡µé¢ï¼Œæ˜¾ç¤ºidå’Œå·²ç»åŠ å…¥æˆ¿é—´çš„äººï¼Œè¿˜æœ‰xå·
   //ç‚¹å‡»xå·ä¼šæœ‰æç¤ºï¼Œä¹‹åé€€å‡ºæˆ¿é—´ï¼Œå‘åç«¯å‘ä¿¡æ¯ï¼Œä¹‹åæˆ¿é—´é”€æ¯
   //äººæ•°è¾¾åˆ°4ä¸ªåç‚¹å‡»ç¡®å®šå¯ä»¥å¼€å§‹æ¸¸æˆï¼Œä¹Ÿå¯ä»¥ç‚¹å‡»äººæœºæ¨¡å¼ï¼Œä¹‹åè¿›å…¥æ¸¸æˆé¡µé¢

   //ä¸‹é¢çš„åˆ›å»ºæˆ¿é—´å•Šä¹‹ç±»çš„æ–¹æ³•æ—¥åä¹Ÿèƒ½æ”¾åœ¨gameStateé‡Œï¼Ÿ
   function createRoom() {
      socket.emit('create_room', gameState.playerInfo.id); // å‘é€åˆ›å»ºæˆ¿é—´è¯·æ±‚
   }



   function joinRoom() {
      // è·å–æˆ¿é—´ID
      const roomId = document.querySelector('.room-input').value;
      console.log(roomId);
      if (roomId) {
         // å‘é€åŠ å…¥æˆ¿é—´è¯·æ±‚
         socket.emit('join_room', {
            roomId,
            playerInfo: gameState.playerInfo
         });
         //æ³¨æ„ä¸€ä¸ªé—®é¢˜ï¼Œå‘é€ä¿¡æ¯æ˜¯ å¦‚æœç›´æ¥ç©¿å˜é‡ï¼Œå‰ç«¯åç«¯åå­—åº”ä¸€è‡´ï¼Œè¦ä¹ˆå°±åƒè¿™æ · playerInfo:thisplayerInfoï¼Œåç«¯ç”¨playerInfoæ¥æ”¶
      }

   }

   function startGame() {
      if (gameState.playerInfo.isHost) {
         Swal.fire({
            title: 'å‡†å¤‡å¥½äº†å—ï¼Ÿ',
            text: "äººæ•°ä¸è¶³å››äººæ—¶ï¼Œå°†ä»¥æœºå™¨äººä»£æ›¿ç©ºç¼ºç©å®¶",
            icon: 'question',
            showCancelButton: true,
            confirmButtonColor: '#3085d6',
            cancelButtonColor: '#d33',
            confirmButtonText: 'å¼€å§‹æ¸¸æˆ',
            cancelButtonText: 'å–æ¶ˆ'

         }).then((result) => {
            if (result.isConfirmed) {
               if (gameState.roomInfo.playerList.length < 4) {
                  // å¦‚æœäººæ•°ä¸è¶³4äººï¼Œå°†è‡ªåŠ¨æ·»åŠ æœºå™¨äºº
                  const robotPromises = [];
                  for (let i = gameState.roomInfo.playerList.length; i < 4; i++) {
                     const robotInfo = {
                        id: gameState.playerInfo.id + "_robot" + i,
                        name: null,
                        avatar: null,
                        OverLook: null,
                        isHost: false,
                        isRobot: true
                     };
                     const promise = initPlayerInfo().then(playerData => {
                        Object.assign(robotInfo, playerData);
                        console.log(robotInfo);
                        socket.emit('join_room', {
                           roomId: gameState.roomInfo.roomId,
                           playerInfo: robotInfo
                        });
                     }).catch(error => {
                        console.error('åˆå§‹åŒ–ç©å®¶ä¿¡æ¯å¤±è´¥:', error);
                     });
                     robotPromises.push(promise);
                  }

                  // ç­‰å¾…æ‰€æœ‰æœºå™¨äººä¿¡æ¯åˆå§‹åŒ–å®Œæˆ
                  Promise.all(robotPromises).then(() => {
                     document.getElementById('playersDiv').remove();
                     // åŠ è½½æ¸¸æˆé¡µé¢
                     showScreenWithLoading('game', 'åŠ è½½æ¸¸æˆé¡µé¢ä¸­');
                     

                     socket.emit('start_game', { roomId: gameState.roomInfo.roomId }); // å‘é€å¼€å§‹æ¸¸æˆè¯·æ±‚
                  });
               } else {
                  document.getElementById('playersDiv').remove();
                  
                  socket.emit('start_game', { roomId: gameState.roomInfo.roomId }); // å‘é€å¼€å§‹æ¸¸æˆè¯·æ±‚
                  // åŠ è½½æ¸¸æˆé¡µé¢
                  showScreenWithLoading('game', 'åŠ è½½æ¸¸æˆé¡µé¢ä¸­');
                  //å»¶è¿Ÿä¸€ç§’å
                  setTimeout(() => {
                     // åŠ è½½æ¸¸æˆé¡µé¢
                     showScreenWithLoading('game', 'æ›´æ–°è§’è‰²å½¢è±¡ä¸­'); 
                  },1000);
               }
            }
            else {
               Swal.fire({
                  title: 'å·²å–æ¶ˆ',
                  icon: 'error',
                  confirmButtonColor: '#3085d6',
                  confirmButtonText: 'ç¡®å®š'
               });
            }
         })



      }
      else {
         Swal.fire({
            title: 'ä½ ä¸æ˜¯æˆ¿ä¸»ï¼Œæ— æ³•å¼€å§‹æ¸¸æˆ',
            icon: 'error',
            confirmButtonColor: '#3085d6',
            confirmButtonText: 'ç¡®å®š'
         });
      }
   }
   function closeDiv() {
      //å¼¹çª—:ä½ ç¡®è®¤è¦é€€å‡ºæˆ¿é—´å—ï¼Ÿ
      if (gameState.playerInfo.isHost) {
         Swal.fire({
            title: 'ä½ ç¡®è®¤è¦é€€å‡ºæˆ¿é—´å—ï¼Ÿ',
            text: "æˆ¿é—´ä¼šè¢«é”€æ¯ï¼Œå…¶ä»–ç©å®¶ä¹Ÿä¼šè¢«è¸¢å‡ºæˆ¿é—´",
            icon: 'warning',
            showCancelButton: true,
            confirmButtonColor: '#3085d6',
            cancelButtonColor: '#d33',
            confirmButtonText: 'é€€å‡º',
            cancelButtonText: 'å–æ¶ˆ'
         }).then((result) => {
            if (result.isConfirmed) {
               //åˆ é™¤æˆ¿é—´
               document.getElementById('playersDiv').remove();
               localStorage.removeItem('roomId'); // ä»æœ¬åœ°å­˜å‚¨ä¸­ç§»é™¤æˆ¿é—´ID
               // socket.emit('close_room', { roomId: localStorage.getItem('roomId') }); // å‘é€å…³é—­æˆ¿é—´è¯·æ±‚
               //è¿™ä¸€éƒ¨åˆ†åç«¯è¿˜æ²¡å†™
            }
         });


      } else {
         Swal.fire({
            title: 'ä½ ç¡®è®¤è¦é€€å‡ºæˆ¿é—´å—ï¼Ÿ',
            icon: 'warning',
            showCancelButton: true,
            confirmButtonColor: '#3085d6',
            cancelButtonColor: '#d33',
            confirmButtonText: 'é€€å‡º',
            cancelButtonText: 'å–æ¶ˆ'
         }).then((result) => {
            if (result.isConfirmed) {
               document.getElementById('playersDiv').remove();

            }
         });

      }
   }
   //åˆ›å»ºæˆ¿é—´/åŠ å…¥æˆ¿é—´æˆåŠŸåæˆ–åŠ å…¥æ¸¸æˆæˆåŠŸåå±•ç¤ºä¸€ä¸ªæˆ¿é—´åŠ å…¥é¡µé¢ï¼ˆdivï¼‰(æœ¬æ¥å­˜åœ¨ä½†éšè—)
   //éšè—çš„å¥½å¤„æ˜¯ï¼Œä¸ç”¨æ‹…å¿ƒdomåˆ›å»ºè¿‡ç¨‹æ—¶å¯¼è‡´å¼‚æ­¥æ“ä½œ
   function intiDiv(roomId) {
      const players_Div = document.getElementById('playersDiv');
      players_Div.style.display = 'flex';
      players_Div.querySelector('#roomIDspan').innerHTML = `æˆ¿é—´ID: ${roomId}`;
      //åœ¨è¿™é‡Œæ·»åŠ ä¸€ä¸‹ç›‘å¬å™¨ï¼Œä¸€ä¸ªæ˜¯å…³é—­ï¼Œä¸€ä¸ªæ˜¯å¼€å§‹æ¸¸æˆ
      players_Div.querySelector('#closeButton').addEventListener('click', () => {
         console.log("å…³é—­æŒ‰é’®è¢«ç‚¹å‡»");
         closeDiv(); // è°ƒç”¨å…³é—­å‡½æ•°
      });
      players_Div.querySelector('#startButton').addEventListener('click', () => {
         console.log("å¼€å§‹æ¸¸æˆæŒ‰é’®è¢«ç‚¹å‡»");
         startGame(); // è°ƒç”¨å¼€å§‹æ¸¸æˆå‡½æ•°
      });
      //å¦‚æœç©å®¶éæˆ¿ä¸»çš„è¯ï¼Œéšè—å¼€å§‹æ¸¸æˆæŒ‰é’®
      if (!gameState.playerInfo.isHost) {
         players_Div.querySelector('#startButton').style.display = 'none';
      }
   }
   // å¥½å‹åˆ—è¡¨åˆ‡æ¢
   function toggleFriends() {
      const sidebar = document.getElementById('friendsSidebar');
      sidebar.classList.toggle('open');
   }
</script>
<script>
   socket.on('room_created', (roomId) => {
      console.log(`Room created with ID: ${roomId}`); // æ¥æ”¶åˆ›å»ºæˆåŠŸçš„æ¶ˆæ¯ 
      gameState.playerInfo.isHost = true; //æ›´æ–°æˆ¿ä¸»èº«ä»½
      localStorage.setItem('roomId', roomId); //æŠŠæˆ¿é—´IDä¿å­˜åˆ°æœ¬åœ°å­˜å‚¨ä¸­
      socket.emit('join_room', {
         roomId,
         playerInfo: gameState.playerInfo
      }); // å‘é€åŠ å…¥æˆ¿é—´è¯·æ±‚
      console.log("å‘é€äº†åŠ å…¥æˆ¿é—´è¯·æ±‚");
   })

   socket.on('room_joined', (data) => {
      //å¦‚æœidå­—æ®µä¸­æœ‰_robot
      if (String(data.id).includes('_robot')) {

      }
      else {
         console.log(`Joined room with ID: ${data.roomId}`); // æ¥æ”¶åŠ å…¥æˆåŠŸçš„æ¶ˆæ¯
         localStorage.setItem('roomId', data.roomId); //æŠŠæˆ¿é—´IDä¿å­˜åˆ°æœ¬åœ°å­˜å‚¨ä¸­
         gameState.roomInfo.roomId = data.roomId; //æ›´æ–°æˆ¿é—´ID
         gameState.playerInfo.id = data.id; //æ›´æ–°ç©å®¶ID
         intiDiv(gameState.roomInfo.roomId); //åˆå§‹åŒ–æˆ¿é—´åŠ å…¥é¡µé¢
      }

   })

   //æ¥æ”¶å¹¿æ’­çš„ç©å®¶åŠ å…¥äº‹ä»¶ï¼Œç”¨äºåŒæ­¥æ›´æ–°ç©å®¶åŠ å…¥ç•Œé¢ï¼Œæˆ‘è®¤ä¸ºè¿™é‡Œåº”è¯¥ç›´æ¥å‘è¿‡æ¥ç©å®¶åˆ—è¡¨æ•°ç»„
   socket.on('player_joined', (data) => {

      const playerlist = data.playerList; //è·å–ç©å®¶åˆ—è¡¨
      const playerInfo = data.playerInfo; //è·å–ç©å®¶ä¿¡æ¯
      console.log(`Player joined: ${playerInfo.name}`); // æ¥æ”¶ç©å®¶åŠ å…¥çš„æ¶ˆæ¯
      if (playerInfo.isRobot) {

      }
      else {
         //æ˜¾ç¤ºç©å®¶åŠ å…¥çš„å¼¹çª—
         Swal.fire({
            position: 'center',
            icon: 'info',
            title: `${playerInfo.name} åŠ å…¥äº†æˆ¿é—´`,
            showConfirmButton: false,
            timer: 1500
         });
      }

      //console.log(playerlist);
      gameState.roomInfo.updateList(playerlist); //æ›´æ–°ç©å®¶åˆ—è¡¨
   })

   socket.on('error', (errorInfo) => {
      Swal.fire({
         title: errorInfo,
         icon: 'warning',
         confirmButtonColor: '#3085d6',
         confirmButtonText: 'ç¡®è®¤',
      })
   })

   socket.on('game_started', (data) => {
      //æ˜¾ç¤ºå¼¹çª—
      Swal.fire({
         position: 'center',
         title: 'æ¸¸æˆå¼€å§‹',
         icon: 'success',
         showConfirmButton: false,
         timer: 500


      })
      console.log("æ¸¸æˆå¼€å§‹");
      renderPlayerSelf();
      const opponentInfos = gameState.roomInfo.playerList.filter(player => player.id !== gameState.playerInfo.id);; //è·å–å¯¹æ‰‹ä¿¡æ¯
      updateGameOpponentInfo(opponentInfos);
   });

   socket.on('round_started', (data) => {
      //éœ€è¦ä¸€ä¸ªæ•°æ®ç±»å‹å»è®°å½•ç›®æ ‡ç‰Œå’Œæ‰‹ç‰Œäº†
      gameState.gameManager.targetCard = data.targetCard; //æ›´æ–°ç›®æ ‡ç‰Œ
      set_target(data.targetCard); //æ›´æ–°ç›®æ ‡ç‰Œ
      console.log("ç›®æ ‡ç‰Œï¼š" + gameState.gameManager.targetCard);
      showGameEventMessage("ç›®æ ‡ç‰Œï¼š" + gameState.gameManager.targetCard);
      socket.emit('deal_cards', { playerId: gameState.playerInfo.id, roomId: gameState.roomInfo.roomId }); //å‘é€å‘ç‰Œè¯·æ±‚
      console.log("å‘é€äº†å‘ç‰Œè¯·æ±‚");
      showGameEventMessage("å‘é€äº†å‘ç‰Œè¯·æ±‚");

   })
   socket.on('cards_dealt', (data) => {
      gameState.gameManager.hands = data; //æ›´æ–°å·²å‡ºçš„ç‰Œ
      console.log(data);
      console.log("æ”¶åˆ°äº†å‘ç‰Œä¿¡æ¯");
      showGameEventMessage("æ”¶åˆ°äº†å‘ç‰Œä¿¡æ¯");
      console.log(gameState.gameManager.hands);
      setTimeout(() => { if (dealCards()) setTimeout(drawCard, 1300) }, 500);
      //å‘ç‰ŒåŠ¨ç”»
   });
   socket.on('start_timer', (timestamp) => {
      showGameEventMessage("å¼€å§‹å€’è®¡æ—¶");
      const timerElement = document.getElementById('timer');
      if (!timerElement) return;

      // æ¸…é™¤ç°æœ‰å®šæ—¶å™¨
      if (timerInterval) {
         clearInterval(timerInterval);
      }
      const now = Date.now();
      const delay = timestamp - now;

      // å¦‚æœæ—¶é—´æˆ³å·²ç»è¿‡å»ï¼Œç«‹å³å¼€å§‹å€’è®¡æ—¶
      if (delay <= 0) {
         startCountdown(timerElement);
      } else {
         // åœ¨æŒ‡å®šæ—¶é—´æˆ³è§¦å‘å€’è®¡æ—¶
         setTimeout(() => {
            startCountdown(timerElement);
         }, delay);
      }
   });

   socket.on('sync_game_state', (state) => {
      Object.assign(gameState.gameManager, state);

      // æŠŠ players æ›´æ–°è¿› Map æ ¼å¼
      const map = new Map();
      for (let p of state.players) {
         map.set(p.id, p);
      }
      gameState.gameManager.players = map;
      showGameEventMessage("æ”¶åˆ°äº†åŒæ­¥ä¿¡æ¯");
      // æ ¹æ® phase æ§åˆ¶ UI æ˜¾ç¤º
      updateUI();
   });
   
   socket.on('cards_played', (data) => {
      if(data.playerId===gameState.playerInfo.id){
        //æ˜¯è‡ªå·±å‡ºçš„ç‰Œï¼Œä¸éœ€è¦åŠ¨ç”» 
      }
      else{
         playOpponentCards(data.playerId, data.cardsNum);
      }
   });
socket.on('challenge_result', (data) => {
   showGameEventMessage("æ”¶åˆ°äº†è´¨ç–‘ç»“æœ");}
   //é¦–å…ˆè§¦å‘è´¨ç–‘åŠ¨ç”»
   //æ¥ç€è§¦å‘ç¿»ç‰ŒåŠ¨ç”»
   //æ¥ç€è§¦å‘æˆåŠŸ/å¤±è´¥åŠ¨ç”»
)



   //æ¥ä¸‹æ¥é¦–å…ˆæŠŠgameç•Œé¢è‡ªèº«çš„ä¸€äº›æµ‹è¯•å‡½æ•°ç»™å»æ‰
   //ç„¶åå‘¢ï¼Œæˆ‘ä»¬å°±å»å†™å‘ç‰Œï¼Œå–ç‰Œï¼Œå‡ºç‰Œç­‰ç­‰çš„å‰åç«¯é€»è¾‘ï¼Œç¡®ä¿èƒ½ç©
   //è‡³äºé¡µé¢ä¸Šéœ€è¦è°ƒæ•´çš„ï¼Œåˆ°æ—¶å€™å†è¯´å§
   //ç„¶åå‘¢ï¼Œé€‚å½“æŠŠä»£ç æ‹†åˆ†ä¸€ä¸‹
</script>
<script>
   //ä»¥ä¸‹æ˜¯æ¸¸æˆç•Œé¢çš„åˆå§‹åŒ–å’ŒåŠ¨ç”»çš„ä»£ç ï¼Œæˆ‘è®¤ä¸ºè‚¯å®šå­˜åœ¨å¤§é‡å†—ä½™ï¼Œä»¥åæ”¹
   //è€Œä¸”æœ‰äº›å‡½æ•°çš„é€»è¾‘æœ¬è¯¥å±äºåç«¯ï¼Œå†è¯´å§
   toggleChat();
   document.getElementById('playedCards').style.visibility = 'hidden';
   //const allcard = ["A", "Q", "K"];
   //const play1 = ["A", "Q", "K", "joker", "joker"];ï¼ˆå‡å·²ä¸§å¤±ä½œç”¨ï¼‰
   let selectedCards = [];
   let timerInterval;
   let currentTime;

   //const deck = initDeck();
   //initdeckå·²ç»åˆ æ‰äº†ï¼Œæ²¡ä¸€ç‚¹ç”¨
   // å›¾ç‰‡å¯¹è±¡
   const cardImages = {
      'A': new Image(),
      'Q': new Image(),
      'K': new Image(),
      'joker': new Image(),
      'back': new Image()
   };
   const cardImagePaths = {
      'A': './assets/images/cards/A.png',
      'Q': './assets/images/cards/Q.png',
      'K': './assets/images/cards/K.png',
      'joker': './assets/images/cards/joker.png',
      'back': './assets/images/cards/card_back.png'
   };
   // è·Ÿè¸ªå·²åŠ è½½çš„å›¾ç‰‡æ•°é‡
   let loadedImages = 0;
   const totalImages = Object.keys(cardImages).length;

   // åŠ è½½æ‰€æœ‰å›¾ç‰‡å¹¶åœ¨å…¨éƒ¨å®Œæˆååˆå§‹åŒ–æ¸¸æˆ
   function loadImages() {
      console.log('å¼€å§‹åŠ è½½å›¾ç‰‡');
      for (const [key, image] of Object.entries(cardImages)) {
         image.onload = () => {
            loadedImages++;
            console.log(`${key} å›¾ç‰‡åŠ è½½å®Œæˆ`);
            if (loadedImages === totalImages) {
               console.log('æ‰€æœ‰å›¾ç‰‡åŠ è½½å®Œæˆï¼Œåˆå§‹åŒ–æ¸¸æˆ');
               //æ˜¯å…ˆç”»ç›®æ ‡ç‰Œå—ï¼Ÿç„¶åæ¸²æŸ“æ‰‹ç‰Œï¼Œç„¶åæ˜¯åœ¨æ¸²æŸ“æ‰‹ç‰Œä¸­åŠ äº†ä¸€å¥æ˜¾ç¤ºç›®æ ‡ç‰Œçš„ï¼Ÿ
               //ç›®æ ‡ç‰Œçš„æ¸²æŸ“æœ‰äº›é‡å¤äº†ï¼Œæ‰€ä»¥ç¬¬äºŒä¸ªæˆ‘ä¼šæ”¹ä¸€ä¸‹å°±æ˜¯newroundå‡½æ•°
               //åŒæ—¶ä¸Šæ¥å°±ç›´æ¥å‘ç‰Œä¸è¡Œï¼Œæˆ‘ä¼šæŠŠè¿™ä¸€æ­¥æ”¾åœ¨å…¶ä»–åœ°æ–¹çš„
               drawtargetCard();
               //setTimeout(() => { if (dealCards()) setTimeout(drawCard, 1300) }, 500);
               //æˆ‘æ˜ç™½è¿™ä¸€è¡Œæ˜¯å¹²å•¥çš„äº†ï¼Œå°±æ˜¯å…ˆè§¦å‘å‘ç‰ŒåŠ¨ç”»ï¼Œç„¶åæ¸²æŸ“æ‰‹ç‰Œ
            }
            else {
               console.log(`è¿˜æœ‰ ${totalImages - loadedImages} å¼ å›¾ç‰‡æœªåŠ è½½`);
            }
         };
         image.onerror = (error) => {
            console.error(`åŠ è½½å›¾ç‰‡ ${key} å¤±è´¥:`, error);
         };
         image.src = cardImagePaths[key];
      }
   }
   //ç›®æ ‡ç‰Œç»˜åˆ¶ï¼ˆèƒŒæ™¯ï¼‰ 
   function drawtargetCard() {
      const targetArea = document.getElementById('targetCard');

      // æ¸…ç©ºç°æœ‰å†…å®¹
      targetArea.innerHTML = '';

      // åˆ›å»ºCanvaså…ƒç´ 
      const targetcanvas = document.createElement('canvas');
      targetcanvas.width = 50;
      targetcanvas.height = 75;
      targetArea.appendChild(targetcanvas);
      const ctx = targetcanvas.getContext('2d');
      ctx.drawImage(cardImages['back'], 0, 0, targetcanvas.width, targetcanvas.height);
      window.targetctx = ctx; // å­˜å‚¨ä¸Šä¸‹æ–‡ä»¥ä¾¿åç»­ä½¿ç”¨

   }
   //é€‰å‡ºç›®æ ‡ç‰Œï¼Œä¸ç›®æ ‡ç‰Œç»˜åˆ¶ï¼ˆèƒŒæ™¯ï¼‰æœ‰é‡å¤é€»è¾‘ï¼Œè¿™é‡Œç”±newroundæ”¹ä¸ºset_target()(è‹±æ–‡æœ‰é—®é¢˜å…ˆä¸ç®¡äº†)
   //å°±æ˜¯ç°æœ‰ä¸€ä¸ªå±€å†…ä¿¡æ¯çš„è®°å½•å’Œæ›´æ–°ï¼Œå†æŠŠç›®æ ‡ç‰Œç±»å‹ä¼ é€’è¿‡æ¥ï¼Œå°±è¿™æ ·ï¼Œoverï¼ˆå·²è§£å†³ï¼‰
   function set_target(nowcard) {
      const targetArea = document.getElementById('targetCard');
      // æ¸…ç©ºç°æœ‰å†…å®¹
      targetArea.innerHTML = '';

      const targetcanvas = document.createElement('canvas');
      targetcanvas.width = 50;
      targetcanvas.height = 75;
      targetcanvas.className = `card ${nowcard}`;
      targetArea.appendChild(targetcanvas);
      const ctx = targetcanvas.getContext('2d');
      ctx.drawImage(cardImages['back'], 0, 0, targetcanvas.width, targetcanvas.height);

      // è°ƒç”¨ç¿»ç‰ŒåŠ¨ç”»
      setTimeout(() => {
         flipCard(ctx, targetcanvas.width, targetcanvas.height, nowcard);
      }, 1000);
      //Timer();
   }
   //ç¿»è½¬ç‰ŒåŠ¨ç”»
   function flipCard(ctx, width, height, nowcard) {
      cardFlipping = true;

      let angle = 0;
      const totalFrames = 30; // åŠ¨ç”»æ€»å¸§æ•°
      const frameDuration = 16; // æ¯å¸§æŒç»­æ—¶é—´ï¼ˆmsï¼‰

      function animate() {
         angle += Math.PI / totalFrames;

         // æ¸…é™¤ç”»å¸ƒ
         ctx.clearRect(0, 0, width, height);

         // ä¿å­˜å½“å‰ä¸Šä¸‹æ–‡çŠ¶æ€
         ctx.save();
         // åº”ç”¨å˜æ¢
         ctx.translate(width / 2, height / 2);
         ctx.scale(Math.abs(Math.cos(angle)), 1);
         ctx.rotate(angle);
         ctx.rotate(angle);
         // ç»˜åˆ¶ç‰Œ
         if (angle < Math.PI / 2) {
            // æ˜¾ç¤ºç‰ŒèƒŒé¢
            ctx.drawImage(cardImages['back'], -width / 2, -height / 2, width, height);
         } else {
            // æ˜¾ç¤ºç‰Œæ­£é¢
            ctx.drawImage(cardImages[nowcard], -width / 2, -height / 2, width, height);
         }

         // æ¢å¤ä¸Šä¸‹æ–‡çŠ¶æ€
         ctx.restore();

         // ç»§ç»­åŠ¨ç”»
         if (angle < Math.PI) {
            requestAnimationFrame(animate);
         } else {
            // åŠ¨ç”»å®Œæˆ
            isCardFlipped = true;
            cardFlipping = false;
         }
      }

      // å¼€å§‹åŠ¨ç”»
      requestAnimationFrame(animate);
   }
   //å‡ºç‰Œ

   // ç©å®¶ä½ç½®ï¼ˆè¿™ä¸ªè‚¯å®šè¦æ›¿æ¢æ‰ï¼‰
   const playersPos = [
      {
         id: 'opponent1',
         hand: [],
         // é¡¶éƒ¨å¯¹æ‰‹ï¼šæ°´å¹³å±…ä¸­ï¼Œå‚ç›´ 60pxï¼ˆä¸ CSS çš„ top: 60px ä¸€è‡´ï¼‰
         position: {
            x: window.innerWidth / 2,
            y: 60
         }
      },
      {
         id: 'opponent2',
         hand: [],
         // å·¦ä¾§å¯¹æ‰‹ï¼šæ°´å¹³ 28% å®½åº¦å¤„ï¼Œå‚ç›´å±…ä¸­ï¼ˆä¸ CSS çš„ left: 28% ä¸€è‡´ï¼‰
         position: {
            x: window.innerWidth * 0.28,
            y: window.innerHeight / 2
         }
      },
      {
         id: 'opponent3',
         hand: [],
         // å³ä¾§å¯¹æ‰‹ï¼šæ°´å¹³ 72% å®½åº¦å¤„ï¼ˆ100% - 28%ï¼‰ï¼Œå‚ç›´å±…ä¸­
         position: {
            x: window.innerWidth * 0.72,
            y: window.innerHeight / 2
         }
      },
      {
         id: 'player1',
         hand: [],
         // ç©å®¶è‡ªå·±ï¼šæ°´å¹³å±…ä¸­ï¼Œå‚ç›´åº•éƒ¨ 100pxï¼ˆä¿æŒåŸé€»è¾‘ï¼‰
         position: {
            x: window.innerWidth / 2,
            y: window.innerHeight - 100
         }
      }
   ];

   // åˆå§‹åŒ–ç‰Œå †Canvasï¼ˆç»˜åˆ¶ç‰ŒèƒŒï¼‰
   function initDeckCanvas() {
      const playCards = document.getElementById('playedCards');
      playCards.style.visibility = 'visible';
      const stx = document.createElement('div');
      stx.className = 'played-card';
      const canvas = document.createElement('canvas');
      canvas.width = 40;
      canvas.height = 56;
      const ctx = canvas.getContext('2d');
      ctx.drawImage(cardImages['back'], 0, 0, canvas.width, canvas.height);
      playCards.style.visibility = 'visible';
      stx.appendChild(ctx.canvas);
      playCards.appendChild(stx);

   }
   // å‘ç‰ŒåŠ¨ç”»ä¸»å‡½æ•°
   function dealCards() {
      initDeckCanvas(); // åˆå§‹åŒ–ç‰Œå †æ˜¾ç¤º
      playersPos.forEach((player, index) => {
         // æ¯ä¸ªç©å®¶å‘5å¼ ç‰Œ
         for (let i = 0; i < 5; i++) {
            //const cardValue = deck.pop();
            //è¿™è¡Œä¸çŸ¥é“ä¸ºä»€ä¹ˆï¼Œæ²¡ç”¨ï¼Œé‚£ä¹ˆåˆå§‹æ‰‹ç‰Œæ˜¯å¦‚ä½•åŠ è½½çš„å‘¢ï¼Ÿå“¦å¥½åƒæ˜¯å†™æ­»çš„
            setTimeout(() => {
               // ä»ç‰Œå †ä½ç½®å¹³ç§»åˆ°ç›®æ ‡ä½ç½®
               const startPos = { x: window.innerWidth / 2, y: window.innerHeight / 2 }; // ç‰Œå †ä¸­å¿ƒ
               const endPos = getPlayerHandPosition(player, i); // è®¡ç®—æ‰‹ç‰Œä½ç½®

               // åˆ›å»ºä¸´æ—¶Canvasç»˜åˆ¶å•å¼ ç‰Œ
               const tempCanvas = document.createElement('canvas');
               tempCanvas.width = 60;
               tempCanvas.height = 90;
               const tempCtx = tempCanvas.getContext('2d');
               tempCtx.drawImage(cardImages['back'], 0, 0, 60, 90);

               // æ‰§è¡Œå¹³ç§»åŠ¨ç”»
               animateCardTranslation(tempCanvas, startPos, endPos, () => {
                  tempCanvas.remove();
               });
            }, index * 100 + i * 200); // å»¶è¿Ÿæ§åˆ¶å‘ç‰Œé¡ºåº
         }
      });
      return 1;
   }

   // è®¡ç®—æ‰‹ç‰Œä½ç½®ï¼ˆæ¨ªå‘æ’åˆ—ï¼‰
   function getPlayerHandPosition(player, index) {
      const baseX = player.position.x;
      const baseY = player.position.y;
      const offsetX = 0;
      return { x: baseX + offsetX, y: baseY };
   }

   // å¹³ç§»åŠ¨ç”»å‡½æ•°
   function animateCardTranslation(canvas, start, end, callback) {
      const ctx = canvas.getContext('2d');
      const duration = 300; // åŠ¨ç”»æ—¶é•¿ï¼ˆmsï¼‰
      const startTimestamp = performance.now();

      function update(timestamp) {
         let progress = (timestamp - startTimestamp) / duration;
         if (progress > 1) progress = 1;

         // çº¿æ€§æ’å€¼è®¡ç®—å½“å‰ä½ç½®
         const currentX = start.x + (end.x - start.x) * progress;
         const currentY = start.y + (end.y - start.y) * progress;

         // ç»˜åˆ¶å½“å‰å¸§
         drawCardAtPosition(canvas, currentX, currentY);

         if (progress < 1) {
            requestAnimationFrame(update);
         } else {
            callback(); // åŠ¨ç”»å®Œæˆå›è°ƒ
         }
      }
      requestAnimationFrame(update);
   }

   // åœ¨æŒ‡å®šä½ç½®ç»˜åˆ¶å¡ç‰Œ
   function drawCardAtPosition(canvas, x, y) {
      const tempDiv = document.createElement('div');
      tempDiv.style.position = 'absolute';
      tempDiv.style.zIndex = 999;
      tempDiv.style.left = `${x}px`;
      tempDiv.style.top = `${y}px`;
      tempDiv.appendChild(canvas);
      document.body.appendChild(tempDiv);
   }

   //æ¸²æŸ“å¡ç‰Œ
   // (è¿™ä¸ªåˆ°åº•æ˜¯å¹²å˜›çš„ï¼Ÿä»¥åŠæœ€åˆçš„å‘ç‰ŒåŠ¨ç”»åˆ°åº•æ˜¯è°å¹²çš„ï¼Ÿ)
   //ï¼ˆè¿™ä¸ªå…¶å®æ˜¯é’ˆå¯¹æ‰‹ç‰Œçš„æ¸²æŸ“ï¼‰
   function drawCard() {
      const playedCards = document.getElementById('playedCards');
      playedCards.innerHTML = '';
      playedCards.style.visibility = 'hidden';
      const handCards = document.getElementById('handCards');
      gameState.gameManager.hands.forEach(({ id: cardId, value: cardValue }) => {
         const cardContainer = document.createElement('div');
         cardContainer.className = 'hand-card';
         cardContainer.dataset.value = cardValue;
         cardContainer.dataset.clicked = "false"; // åˆå§‹åŒ–ç‚¹å‡»çŠ¶æ€
         cardContainer.dataset.id = cardId;

         const frontCanvas = document.createElement('canvas');
         frontCanvas.width = 70;
         frontCanvas.height = 100;
         const frontCtx = frontCanvas.getContext('2d');
         const cardImage = cardImages[cardValue];


         frontCtx.drawImage(cardImage, 0, 0, frontCanvas.width, frontCanvas.height);


         cardContainer.appendChild(frontCanvas);
         handCards.appendChild(cardContainer);
         cardContainer.addEventListener('click', handleCardClick);
      })
      //ä¸ºä»€ä¹ˆè¦æ”¾åœ¨è¿™é‡Œæï¼Œæ³¨é‡Šæ‰çœ‹çœ‹æ•ˆæœ
      //newround();
      //æ³¨é‡Šæ‰åå°±ä¸èƒ½åŠ è½½ç›®æ ‡ç‰Œäº†
      //é‚£ä¹ˆè¿™ä¸ªæ¸²æŸ“å¡ç‰ŒæŒ‡çš„æ˜¯æ¸²æŸ“æ‰‹ç‰Œå—ï¼Ÿæˆ‘å†çœ‹çœ‹ï¼Œæ˜¯çš„
      //æˆ‘è®¤ä¸ºé€»è¾‘åº”è¯¥æ˜¯ï¼Œå…ˆæ¥æ”¶åˆ°game_startçš„æ¶ˆæ¯ï¼Œç„¶åæ˜¾ç¤ºä¸€ä¸ªå°åŠ¨ç”»
      //ç„¶åæ˜¯è·å–ç›®æ ‡ç‰Œround_startedï¼ˆä¹‹åç»˜åˆ¶ï¼‰å’Œå‘ç‰Œï¼ˆå‘deal_cardsè¯·æ±‚ï¼Œæ¥æ”¶cards_dealtï¼‰
   }


   // å¤„ç†å¡ç‰Œç‚¹å‡»äº‹ä»¶
   function handleCardClick(event) {
      const currentPlayerId = gameState.gameManager.currentPlayerId;
      const myPlayerId = gameState.playerInfo.id;
      const isMyTurn = currentPlayerId === myPlayerId;

      // è‹¥ä¸æ˜¯è‡ªå·±å›åˆï¼Œä¸å¤„ç†ç‚¹å‡»äº‹ä»¶
      if (!isMyTurn) {
         return;
      }
      const card = event.currentTarget;
      const isSelected = card.classList.contains('selected');

      // å¦‚æœå·²é€‰å¡ç‰Œè¾¾åˆ°3å¼ ä¸”å½“å‰å¡ç‰Œæœªé€‰ä¸­ï¼Œåˆ™ä¸å¤„ç†ç‚¹å‡»
      if (selectedCards.length >= 3 && !isSelected) {
         return;
      }

      // åˆ‡æ¢é€‰ä¸­çŠ¶æ€
      if (isSelected) {
         card.classList.remove('selected');
         card.style.transform = 'translateY(0)';
         // ä»å·²é€‰åˆ—è¡¨ä¸­ç§»é™¤
         selectedCards = selectedCards.filter(c => c !== card);
      } else {
         card.classList.add('selected');
         card.style.transform = 'translateY(-15px)';
         // æ·»åŠ åˆ°å·²é€‰åˆ—è¡¨
         selectedCards.push(card);
      }

      // æ›´æ–°è‡ªå®šä¹‰å±æ€§
      card.dataset.clicked = isSelected ? "false" : "true";

      // æ›´æ–°å‡ºç‰ŒæŒ‰é’®çŠ¶æ€
      updatePlayButtonState();
   }
   // æ›´æ–°å‡ºç‰ŒæŒ‰é’®çŠ¶æ€
   function updatePlayButtonState() {
      const playSelectedButton = document.getElementById('playBtn');
      if (selectedCards.length > 0 && selectedCards.length <= 3) {
         playSelectedButton.disabled = false;
         playSelectedButton.classList.remove('opacity-50', 'cursor-not-allowed');
      } else {
         playSelectedButton.disabled = true;
         playSelectedButton.classList.add('opacity-50', 'cursor-not-allowed');
      }
   }
   // æ’­æ”¾å¡ç‰ŒåŠ¨ç”»(å“¦åŸæ¥è¿™ä¸ªå°±æ˜¯å‡ºç‰Œçš„å‡½æ•°),æŠŠsocket.emitæ”¾åœ¨è¿™é‡Œäº†
   function playSelectedCards() {
      if (selectedCards.length === 0) return;
      // è·å–çª—å£å°ºå¯¸
      const windowWidth = window.innerWidth;
      const windowHeight = window.innerHeight;

      const playedCardsArea = document.getElementById('playedCards');
      // æ¸…é™¤æç¤ºæ–‡æœ¬
      if (playedCardsArea.querySelector('p')) {
         playedCardsArea.innerHTML = '';
      }

      const targetPositions = [];
      const cardWidth = 70; // å¡ç‰Œå®½åº¦
      const gap = 8; // å¡ç‰Œé—´è·
      const totalWidth = selectedCards.length * cardWidth + (selectedCards.length - 1) * gap;
      const startX = (playedCardsArea.offsetWidth - totalWidth) / 2;

      for (let i = 0; i < selectedCards.length; i++) {
         targetPositions.push({
            x: startX + i * (cardWidth + gap),
            y: playedCardsArea.offsetHeight - 450
         });
      }
      // æå–é€‰ä¸­å¡ç‰Œçš„ id å’Œ value
      const selectedCardData = selectedCards.map(card => ({
         id: card.dataset.id, // å‡è®¾å…ƒç´ æœ‰ data-id å±æ€§
         value: card.dataset.value
      }));

      // å‘é€é€‰ä¸­å¡ç‰Œæ•°æ®åˆ°åç«¯
      socket.emit('play_cards', {
         playerId: gameState.playerInfo.id,
         roomId: gameState.roomInfo.roomId,
         cards: selectedCardData
      });
      showGameEventMessage("å‘é€äº†å‡ºç‰Œä¿¡æ¯");
      console.log(selectedCardData);


      // ä¿å­˜åŸå§‹å¡ç‰Œæ•°æ®å¹¶å¼€å§‹åŠ¨ç”»
      const originalCards = [...selectedCards];
      const originalCardValues = originalCards.map(card => card.dataset.value);

      // å¼€å§‹åŠ¨ç”»
      animateCardsToPlayArea(originalCards, targetPositions, () => {
         // åŠ¨ç”»ç»“æŸåï¼Œæ·»åŠ åˆ°å·²æ‰“å‡ºåŒºåŸŸ
         playedCardsArea.innerHTML = '';
         originalCards.forEach((card, index) => {
            card.style.transform = 'none';
            card.classList.remove('selected');
            playedCardsArea.appendChild(card);
         });

         // ä»æ‰‹ç‰Œä¸­ç§»é™¤å·²æ‰“å‡ºçš„å¡ç‰Œ
         const handCardsArea = document.getElementById('handCards');
         originalCards.forEach(card => {
            if (handCardsArea.contains(card)) {
               handCardsArea.removeChild(card);
            }
         });

         // é‡ç½®å·²é€‰å¡ç‰Œ
         selectedCards = [];
         updatePlayButtonState();

         // ç»˜åˆ¶ç­‰é‡çš„å¡ç‰ŒèƒŒé¢
         for (let i = 0; i < originalCards.length; i++) {
            initDeckCanvas();
         }
      });
      //Timer();
   }

   // å¡ç‰ŒåŠ¨ç”»å‡½æ•°
   function animateCardsToPlayArea(cards, targetPositions, callback) {
      const duration = 800; // åŠ¨ç”»æŒç»­æ—¶é—´ï¼ˆæ¯«ç§’ï¼‰
      const startTime = performance.now();

      // è·å–åˆå§‹ä½ç½®
      const startPositions = cards.map(card => {
         const rect = card.getBoundingClientRect();
         const parentRect = document.getElementById('playedCards').getBoundingClientRect();
         return {
            x: rect.left - parentRect.left,
            y: rect.top - parentRect.top
         };
      });

      // ç¡®ä¿æ‰€æœ‰å¡ç‰Œçš„åˆå§‹ä½ç½®éƒ½æ˜¯æ­£ç¡®çš„
      cards.forEach(card => {
         const rect = card.getBoundingClientRect();
         card.style.position = 'absolute';
         card.style.left = `${rect.left}px`;
         card.style.top = `${rect.top}px`;
         card.style.zIndex = '10';

         // ç¡®ä¿çˆ¶å®¹å™¨æ˜¯ç›¸å¯¹å®šä½
         document.getElementById('playedCards').style.position = 'relative';
         document.body.appendChild(card);
      });

      // åŠ¨ç”»å¾ªç¯
      function animate(currentTime) {
         const elapsedTime = currentTime - startTime;
         const progress = Math.min(elapsedTime / duration, 1);
         const easeProgress = easeOutCubic(progress);

         cards.forEach((card, index) => {
            const startPos = startPositions[index];
            const targetPos = targetPositions[index];

            // è®¡ç®—å½“å‰ä½ç½®
            const currentX = startPos.x + (targetPos.x - startPos.x) * easeProgress;
            const currentY = startPos.y + (targetPos.y - startPos.y) * easeProgress;

            // åº”ç”¨å˜æ¢
            card.style.transform = `translate(${currentX}px, ${currentY}px)`;
         });

         if (progress < 1) {
            requestAnimationFrame(animate);
         } else {
            // åŠ¨ç”»å®Œæˆ
            callback();
         }
      }

      // å¼€å§‹åŠ¨ç”»
      requestAnimationFrame(animate);
   }

   // ç¼“åŠ¨å‡½æ•°
   function easeOutCubic(t) {
      return 1 - Math.pow(1 - t, 3);
   }
   //å€’è®¡æ—¶ï¼ˆæ˜¯æ—§çš„ï¼Œå·²ç»ä½œåºŸï¼‰
   function Timer() {
      const timerElement = document.getElementById('timer');
      if (!timerElement) return;

      // æ¸…é™¤ç°æœ‰å®šæ—¶å™¨
      if (timerInterval) {
         clearInterval(timerInterval);
      }

      // é‡ç½®æ—¶é—´
      currentTime = 30;
      timerElement.textContent = currentTime;

      // åˆ›å»ºæ–°å®šæ—¶å™¨
      timerInterval = setInterval(updateTimer, 1000);

      function updateTimer() {
         currentTime--;
         timerElement.textContent = currentTime;

         if (currentTime <= 0) {
            clearInterval(timerInterval);
            timerElement.textContent = 'æ—¶é—´åˆ°ï¼';
         }
      }
   }



   // ç¼“åŠ¨å‡½æ•°ï¼ˆè¾…åŠ©å€’è®¡æ—¶ï¼‰
   function easeOutCubic(t) {
      return 1 - Math.pow(1 - t, 3);
   }
   // å¼€å§‹å€’è®¡æ—¶çš„å‡½æ•°
   function startCountdown(timerElement) {
      // é‡ç½®æ—¶é—´
      currentTime = 15;
      timerElement.textContent = currentTime;

      // åˆ›å»ºæ–°å®šæ—¶å™¨
      timerInterval = setInterval(updateTimer, 1000, timerElement);
   }

   // æ›´æ–°å€’è®¡æ—¶çš„å‡½æ•°
   function updateTimer(timerElement) {
      currentTime--;
      timerElement.textContent = currentTime;

      if (currentTime <= 0) {
         clearInterval(timerInterval);
         timerElement.textContent = 'æ—¶é—´åˆ°ï¼';
         // å€’è®¡æ—¶ç»“æŸï¼Œå‘é€ timer_ended äº‹ä»¶
         socket.emit('timer_ended');
      }
   }
   //è¡¨æƒ…åŠèŠå¤©
   function toggleChat() {
      const chatContent = document.getElementById('chatContent');
      const toggleBtn = document.querySelector('.chat-toggle');

      if (chatContent.style.display === 'none') {
         chatContent.style.display = 'flex';
         toggleBtn.textContent = 'âˆ’';
      } else {
         chatContent.style.display = 'none';
         toggleBtn.textContent = '+';
      }
   }

   // åˆ‡æ¢è¡¨æƒ…é¢æ¿æ˜¾ç¤º/éšè—
   function toggleEmojiPanel() {
      const emojiPanel = document.getElementById('expressionArea');
      const toggleBtn = document.getElementById('toggle-emoji-btn');

      if (emojiPanel.style.display === 'none' || emojiPanel.style.display === '') {
         emojiPanel.style.display = 'block';
         toggleBtn.innerHTML = 'ğŸ™Š éšè—è¡¨æƒ…';
         document.getElementById('quickPanel').style.display = 'none';
         document.getElementById('toggle-quick-btn').innerHTML = 'ğŸ’¬ æ˜¾ç¤ºçŸ­è¯­'; // ä¿®æ­£è¿™é‡Œ
      } else {
         emojiPanel.style.display = 'none';
         toggleBtn.innerHTML = 'ğŸ˜€ æ˜¾ç¤ºè¡¨æƒ…';
      }
   }

   // åˆ‡æ¢å¿«æ·çŸ­è¯­é¢æ¿æ˜¾ç¤º/éšè—
   function toggleQuickPanel() {
      const quickPanel = document.getElementById('quickPanel');
      const toggleBtn = document.getElementById('toggle-quick-btn');

      if (quickPanel.style.display === 'none' || quickPanel.style.display === '') {
         quickPanel.style.display = 'block';
         toggleBtn.innerHTML = 'ğŸ™Š éšè—çŸ­è¯­';
         document.getElementById('expressionArea').style.display = 'none';
         document.getElementById('toggle-emoji-btn').innerHTML = 'ğŸ˜€ æ˜¾ç¤ºè¡¨æƒ…'; // ä¿®æ­£è¿™é‡Œ
      } else {
         quickPanel.style.display = 'none';
         toggleBtn.innerHTML = 'ğŸ’¬ æ˜¾ç¤ºçŸ­è¯­';
      }
   }

   // æ’å…¥å†…å®¹åˆ°è¾“å…¥æ¡†
   function insertIntoInput(content) {
      const input = document.getElementById('messageInput');
      input.value += content;
      input.focus();
   }

   // å‘é€æ–‡æœ¬æ¶ˆæ¯
   function sendMessage() {
      const input = document.getElementById('messageInput');
      const message = input.value.trim();
      if (message) {
         appendMessage(message);
         input.value = ''; // æ¸…ç©ºè¾“å…¥æ¡†
         document.getElementById('expressionArea').style.display = 'none';
         document.getElementById('quickPanel').style.display = 'none';
         document.getElementById('toggle-emoji-btn').innerHTML = 'ğŸ˜€ æ˜¾ç¤ºè¡¨æƒ…';
         document.getElementById('toggle-quick-btn').innerHTML = 'ğŸ’¬ æ˜¾ç¤ºçŸ­è¯­';

      }
   }

   // è¿½åŠ æ¶ˆæ¯åˆ°èŠå¤©çª—å£
   function appendMessage(content) {
      const chatMessages = document.getElementById('chatMessages');
      const newMessage = document.createElement('div');
      newMessage.className = 'chat-message player';
      newMessage.textContent = 'ä½ : ' + content;
      chatMessages.appendChild(newMessage);

      // æ»šåŠ¨åˆ°åº•éƒ¨
      chatMessages.scrollTop = chatMessages.scrollHeight;
   }

   // æ”¯æŒæŒ‰Enterå‘é€æ¶ˆæ¯
   document.getElementById('messageInput').addEventListener('keypress', function (e) {
      if (e.key === 'Enter') {
         sendMessage();
      }
   });


   //è¿™æ˜¯ä¹‹å‰çš„ç‰ˆæœ¬ï¼Œè¦æ”¹æ‰ï¼Œæ‹†åˆ†æˆ1.è´¨ç–‘åŠ¨ç”»2.ç¿»ç‰ŒåŠ¨ç”»3.æˆåŠŸ/å¤±è´¥åŠ¨ç”»
   //ç¿»è½¬ç‰Œï¼Œå¹¶é€šè¿‡åˆ¤æ–­æ˜¯å¦æ¸²æŸ“å¼€æªåŠ¨ç”»
   function challenge() {

      function checkcard() {
         const playedCards = document.getElementById('playedCards');
         const cardElements = playedCards.querySelectorAll('.played-card canvas');

         // é€ä¸ªç¿»è½¬å¡ç‰Œ
         cardElements.forEach((canvas, index) => {
            const ctx = canvas.getContext('2d');
            const width = canvas.width;
            const height = canvas.height;

            // å»¶è¿Ÿæ‰§è¡Œï¼Œä½¿å¡ç‰Œé€ä¸ªç¿»è½¬
            setTimeout(() => {
               // é€‰æ‹©å¯¹åº”çš„å¡ç‰Œæ­£é¢å›¾åƒ;
               flipCard(ctx, width, height, 'A');//å¡ç‰Œæ­£é¢ç›´æ¥è®¾ç½®ä¸ºAï¼Œéœ€è¦ä»ç©æ³•ä¸­çš„æ¡Œå­ä¸­ç‰Œæ¥é‡æ–°è®¾ç½®
            }, index * 200); // æ¯å¼ å¡ç‰Œé—´éš”200ms
         });
         if (1) return cardElements.length;//åŠ å…¥åˆ¤æ–­é€»è¾‘ï¼Œè´¨ç–‘æ˜¯å¦æˆåŠŸ
      }
      //è¿›è¡Œå¼€æªæµ‹è¯•
      function gun() {


         var buffer = document.getElementById('opponent2')
         var right = buffer.querySelector('.character-item-right')
         var head = buffer.querySelector('.character-head')
         const rightoriginal = right.textContent
         const headoriginal = head.textContent
         right.textContent = 'ğŸ”«'
         head.textContent = 'ğŸ˜±'
         right.classList.add('gun-animation');
         // åŠ¨ç”»ç»“æŸåæ”¹å˜å¤´éƒ¨ä¸ºéª·é«…
         right.addEventListener('animationend', function animationEndHandler() {
            const isDead = Math.random() > 0.833;
            if (isDead) {
               head.textContent = 'ğŸ’€';
               right.textContent = 'âš°ï¸';
            }
            else {
               head.textContent = headoriginal
               right.textContent = rightoriginal
            }
            right.classList.remove('gun-animation');
            right.removeEventListener('animationend', animationEndHandler);
         });
      }

      const isChallengeSuccess = checkcard();
      if (isChallengeSuccess != 0) {
         setTimeout(gun, (isChallengeSuccess + 1) * 200);
         setTimeout(() => {
            const playedCards = document.getElementById('playedCards');
            playedCards.innerHTML = '';
            playedCards.style.visibility = 'hidden';
         }, (isChallengeSuccess + 2) * 200);
      }
      else {
         setTimeout(() => {
            const playedCards = document.getElementById('playedCards');
            playedCards.innerHTML = '';
            playedCards.style.visibility = 'hidden';
         }, (isChallengeSuccess + 1) * 200);
      }

   }

   // æ˜¾ç¤ºæ¸¸æˆäº‹ä»¶ä¿¡æ¯çš„å‡½æ•°
   function showGameEventMessage(message) {
      const eventMessagesDiv = document.getElementById('eventMessages');
      const newMessage = document.createElement('p');
      newMessage.textContent = message;
      eventMessagesDiv.appendChild(newMessage);
      // è‡ªåŠ¨æ»šåŠ¨åˆ°æœ€æ–°æ¶ˆæ¯
      eventMessagesDiv.scrollTop = eventMessagesDiv.scrollHeight;
   }

   // æ¸…é™¤æ¸¸æˆäº‹ä»¶ä¿¡æ¯çš„å‡½æ•°
   function clearEventMessages() {
      const eventMessagesDiv = document.getElementById('eventMessages');
      eventMessagesDiv.innerHTML = '';
   }

   function updateUI() {
      //ä¼šæ ¹æ®gameStateæ¥æ›´æ–°UI 
      const playBtn = document.getElementById('playBtn');
      const challengeBtn = document.getElementById('challengeBtn');
      const selectionInfo = document.getElementById('selectionInfo');
      const currentPlayerId = gameState.gameManager.currentPlayerId;
      const myPlayerId = gameState.playerInfo.id;

      //å¥½ç¥å¥‡ï¼Œä¸ºä»€ä¹ˆæˆ‘çš„IDå˜æˆrobotäº†ï¼Ÿ
      //æˆ‘æƒ³æˆ‘çŸ¥é“äº†ï¼Œå› ä¸ºrobotåŠ å…¥æˆ¿é—´ä¹Ÿä¼šå‘é€room_joinedæ¶ˆæ¯ï¼Œæ‰€ä»¥ä¼šæ›´æ–°id
      showGameEventMessage(`å½“å‰ç©å®¶ID:${currentPlayerId}`);
      // åˆ¤æ–­æ˜¯å¦ä¸ºè‡ªå·±çš„å›åˆ
      const isMyTurn = currentPlayerId === myPlayerId;

      // æ ¹æ®æ˜¯å¦ä¸ºè‡ªå·±çš„å›åˆæ¥å¯ç”¨æˆ–ç¦ç”¨æŒ‰é’®
      playBtn.disabled = !isMyTurn;
      challengeBtn.disabled = !isMyTurn;

      // æ›´æ–°æŒ‰é’®çš„æ ·å¼ï¼Œä½¿å…¶åœ¨ç¦ç”¨çŠ¶æ€ä¸‹æœ‰è§†è§‰åé¦ˆ
      if (!isMyTurn) {
         playBtn.classList.add('opacity-50', 'cursor-not-allowed');
         challengeBtn.classList.add('opacity-50', 'cursor-not-allowed');
         selectionInfo.textContent = "ä¸æ˜¯ä½ çš„å›åˆ";

      } else {
         playBtn.classList.remove('opacity-50', 'cursor-not-allowed');
         challengeBtn.classList.remove('opacity-50', 'cursor-not-allowed');
         selectionInfo.textContent = "ä½ çš„å›åˆï¼Œè¯·é€‰æ‹©";
         showGameEventMessage("ä½ çš„å›åˆå¼€å§‹äº†");
      }
      const allOpponentElements = document.querySelectorAll('.opponent');

      allOpponentElements.forEach(opponentElement => {
         //ç¡®å®šå½“å‰ç©å®¶
         //console.log("æˆ‘å¼€å§‹æ‰§è¡Œäº†");
         //æ‰€ä»¥åº”è¯¥ä¸æ˜¯æ¬¡åºçš„é—®é¢˜
         const opponentName = opponentElement.querySelector('.opponent-name');
         const playerId = opponentName?.dataset.player_id;
         if (playerId === String(currentPlayerId)) {
            opponentElement.classList.add('active');
            console.log(`${opponentName.textContent}çš„å›åˆå¼€å§‹äº†`);
         } else {
            opponentElement.classList.remove('active');
         }
         //ä¸‹é¢è¿™äº›ä¼¼ä¹æ²¡æœ‰æ­£å¸¸è¿è¡Œï¼Œè€Œä¸”åœ¨å›åˆå¼€å§‹çš„æ—¶å€™ä¹Ÿæ²¡æœ‰è¿è¡Œï¼Œä¸ç†è§£
         //æˆ‘çŸ¥é“ä¸ºä»€ä¹ˆäº†ï¼Œå°±æ˜¯å› ä¸ºupdateå‡½æ•°å±…ç„¶å‘ç”Ÿåœ¨æ¸¸æˆè§’è‰²åˆå§‹åŒ–ä¹‹å‰
         //é‚£ä¹ˆè¿™æ ·é“å®šè¢«é‡ç»˜å•Š
         // æ›´æ–°æ¯ä¸ªå¯¹æ‰‹æ‰‹ç‰Œæ•°
         const opponentInfo = gameState.gameManager.players.get(playerId);
         if (opponentInfo) {
            const opponentCards = opponentElement.querySelector('.opponent-cards');
            if (opponentCards) {
               opponentCards.textContent = `${opponentInfo.handCount} å¼ ç‰Œ`;
            }

            // æ›´æ–°æ¯ä¸ªå¯¹æ‰‹å‰©ä½™å­å¼¹æ•°
            const opponentBullets = opponentElement.querySelectorAll('.bullet');
            opponentBullets.forEach((bullet, index) => {
               bullet.classList.toggle('used', index >= opponentInfo.bulletCount);
            });
         }
         else {
            console.log(`æœªæ‰¾åˆ°ç©å®¶ ${playerId} çš„ä¿¡æ¯`);
         }

      });
      const playerSelf = document.getElementById('playerSelf');
      if (playerSelf) {
         const playerCards = playerSelf.querySelector('.player-cards');
         if (playerCards) {
            playerCards.textContent = `${gameState.gameManager.players.get(gameState.playerInfo.id).handCount} å¼ ç‰Œ`;
         }
         else {
            console.log(`æœªæ‰¾åˆ°ç©å®¶ ${playerId} çš„ä¿¡æ¯`); 
         }

         // æ›´æ–°ç©å®¶è‡ªèº«å‰©ä½™å­å¼¹æ•°
         const playerBullets = playerSelf.querySelectorAll('.bullet');
         playerBullets.forEach((bullet, index) => {
            bullet.classList.toggle('used', index >= gameState.gameManager.bullets);
         });
      }
      else {
         console.log(`æœªæ‰¾åˆ°ç©å®¶ ${playerId} çš„ä¿¡æ¯`); 
      }
   }

 // å¤„ç†å…¶ä»–ç©å®¶å‡ºç‰ŒåŠ¨ç”»çš„å‡½æ•°
 // å¤„ç†å¯¹æ‰‹å‡ºç‰ŒåŠ¨ç”»çš„å‡½æ•°

// å¤„ç†å¯¹æ‰‹å‡ºç‰ŒåŠ¨ç”»çš„å‡½æ•°
// å¤„ç†å¯¹æ‰‹å‡ºç‰ŒåŠ¨ç”»çš„å‡½æ•°
function playOpponentCards(playerId, cardsCount) {
    if (cardsCount <= 0) return;
    
    // 1. æ‰¾åˆ°å¯¹æ‰‹å…ƒç´ 
    const opponentElement = document.querySelector(`.opponent-name[data-player_id="${playerId}"]`);
    if (!opponentElement) {
        console.error(`æ‰¾ä¸åˆ°ç©å®¶ ${playerId} çš„å…ƒç´ `);
        return;
    }
    
    const opponentContainer = opponentElement.closest('.opponent');
    const playedCardsArea = document.getElementById('playedCards');
    
    // 2. æ¸…é™¤æ¡Œé¢ç°æœ‰å¡ç‰Œ
    if (playedCardsArea.querySelector('p')) {
        playedCardsArea.innerHTML = '';
    }
    
    // 3. è®¡ç®—ç›®æ ‡ä½ç½®ï¼ˆæ¡Œé¢ä¸­å¤®çš„å¡ç‰Œæ’åˆ—ä½ç½®ï¼‰
    const cardWidth = 70;
    const gap = 8;
    const totalWidth = cardsCount * cardWidth + (cardsCount - 1) * gap;
    const startX = (playedCardsArea.offsetWidth - totalWidth) / 2;
    
    const targetPositions = [];
    for (let i = 0; i < cardsCount; i++) {
        targetPositions.push({
            x: startX + i * (cardWidth + gap),
            y: playedCardsArea.offsetHeight - 150
        });
    }
    
    // 4. è®¡ç®—å¯¹æ‰‹ä½ç½®ç›¸å¯¹äºæ¡Œé¢çš„åæ ‡
    const opponentRect = opponentContainer.getBoundingClientRect();
    const playedCardsRect = playedCardsArea.getBoundingClientRect();
    const startX_relative = opponentRect.left - playedCardsRect.left + opponentRect.width / 2;
    const startY_relative = opponentRect.top - playedCardsRect.top + opponentRect.height / 2;
    
    // 5. åˆ›å»ºä¸´æ—¶å¡ç‰Œå¹¶è®¾ç½®èµ·å§‹ä½ç½®
    const tempCards = [];
    for (let i = 0; i < cardsCount; i++) {
        // åˆ›å»ºå¡ç‰Œå…ƒç´ 
        const cardContainer = document.createElement('div');
        cardContainer.className = 'hand-card';
        cardContainer.style.position = 'absolute';
        cardContainer.style.left = `${startX_relative}px`;
        cardContainer.style.top = `${startY_relative}px`;
        cardContainer.style.zIndex = '10';
        
        // åˆ›å»ºå¡ç‰Œç”»å¸ƒ
        const canvas = document.createElement('canvas');
        canvas.width = 70;
        canvas.height = 100;
        const ctx = canvas.getContext('2d');
        ctx.drawImage(cardImages['back'], 0, 0, canvas.width, canvas.height);
        
        cardContainer.appendChild(canvas);
        playedCardsArea.appendChild(cardContainer);
        tempCards.push(cardContainer);
    }
    
    // 6. æ‰§è¡ŒåŠ¨ç”»
    animateOpponentCards(tempCards, targetPositions, () => {
        // åŠ¨ç”»å®Œæˆåçš„å›è°ƒ
        tempCards.forEach(card => card.remove());
        
        // åœ¨æ¡Œé¢æ˜¾ç¤ºæœ€ç»ˆçš„å¡ç‰ŒèƒŒé¢
        playedCardsArea.innerHTML = '';
        for (let i = 0; i < cardsCount; i++) {
            initDeckCanvas();
        }
        playedCardsArea.style.visibility = 'visible';
    });
}

// å¯¹æ‰‹å¡ç‰ŒåŠ¨ç”»å‡½æ•°
function animateOpponentCards(cards, targetPositions, callback) {
    const duration = 800;
    const startTime = performance.now();
    
    // è·å–èµ·å§‹ä½ç½®
    const startPositions = cards.map(card => ({
        x: parseFloat(card.style.left),
        y: parseFloat(card.style.top)
    }));
    
    function animate(currentTime) {
        const elapsedTime = currentTime - startTime;
        const progress = Math.min(elapsedTime / duration, 1);
        const easeProgress = easeOutCubic(progress);
        
        cards.forEach((card, index) => {
            const startPos = startPositions[index];
            const targetPos = targetPositions[index];
            
            // è®¡ç®—å½“å‰ä½ç½®
            const currentX = startPos.x + (targetPos.x - startPos.x) * easeProgress;
            const currentY = startPos.y + (targetPos.y - startPos.y) * easeProgress;
            
            // æ›´æ–°å¡ç‰Œä½ç½®
            card.style.left = `${currentX}px`;
            card.style.top = `${currentY}px`;
        });
        
        if (progress < 1) {
            requestAnimationFrame(animate);
        } else {
            callback();
        }
    }
    
    requestAnimationFrame(animate);
}

   loadImages();

</script>

</html>